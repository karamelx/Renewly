<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>re-newly</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='7' fill='%236b5335'/%3E%3Ctext x='3' y='25' font-family='Georgia,serif' font-size='23' font-style='italic' font-weight='400' fill='%23faf6ef' letter-spacing='-1'%3Ere%3C/text%3E%3C/svg%3E">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;1,400&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#f2ece0; --surface:#faf6ef; --surface2:#f5f0e6;
  --border:#ddd5c4; --border2:#c9bfad;
  --text:#1e1a14; --muted:#8a7f72; --faint:#b8ad9e;
  --accent:#6b5335; --accent-h:#5a4429;
  --danger:#9e3d3a; --warn:#9e6a2a; --ok:#2e6b50;
}
[data-theme="dark"] {
  --bg:#161310; --surface:#1e1a14; --surface2:#252018;
  --border:#2e2820; --border2:#3d3528;
  --text:#f0e8d8; --muted:#9a8f80; --faint:#5a5248;
  --accent:#a07850; --accent-h:#b88a60;
  --danger:#c0524e; --warn:#c08040; --ok:#3d8f6a;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Outfit',sans-serif;font-weight:400;background:var(--bg);color:var(--text);min-height:100vh;font-size:14px;line-height:1.5;transition:background .3s,color .3s;}

/* LOADING */
.loading-screen{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:999;transition:opacity .3s ease;}
.loading-screen.fade-out{opacity:0;pointer-events:none;}
.spinner-ring{width:36px;height:36px;border:2.5px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;}
.spinner-text{font-size:12px;color:var(--faint);letter-spacing:2px;text-transform:uppercase;font-weight:500;}
@keyframes spin{to{transform:rotate(360deg);}}

/* AUTH */
.auth-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;}
.auth-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;width:100%;max-width:420px;overflow:hidden;}
.auth-header{padding:36px 36px 28px;text-align:center;border-bottom:1px solid var(--border);background:var(--surface2);}
.auth-body{padding:28px 36px 36px;}
.auth-tabs{display:flex;border:1px solid var(--border);border-radius:6px;overflow:hidden;margin-bottom:20px;}
.auth-tab{flex:1;padding:9px;font-family:'Outfit',sans-serif;font-size:12px;font-weight:600;border:none;background:transparent;cursor:pointer;color:var(--muted);transition:all .15s;}
.auth-tab.active{background:var(--accent);color:#faf6ef;}
.auth-field{margin-bottom:16px;}
.auth-field label{display:block;font-size:11px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.auth-field input{width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:6px;background:var(--bg);font-family:'Outfit',sans-serif;font-size:13px;color:var(--text);outline:none;transition:border-color .15s;}
.auth-field input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(107,83,53,.08);}
.auth-error{background:rgba(158,61,58,.06);border:1px solid rgba(158,61,58,.2);border-radius:6px;padding:10px 14px;font-size:12px;color:var(--danger);margin-bottom:16px;display:none;}
.auth-error.show{display:block;}
.auth-divider{text-align:center;font-size:11px;color:var(--faint);margin:16px 0;position:relative;}
.auth-divider::before,.auth-divider::after{content:'';position:absolute;top:50%;width:42%;height:1px;background:var(--border);}
.auth-divider::before{left:0;} .auth-divider::after{right:0;}

/* BUTTONS */
.btn{padding:10px 18px;border-radius:6px;font-family:'Outfit',sans-serif;font-size:13px;font-weight:600;cursor:pointer;border:1px solid transparent;transition:all .15s;}
.btn-primary{background:var(--accent);color:#faf6ef;border-color:var(--accent);}
.btn-primary:hover{background:var(--accent-h);}
.btn-ghost{background:transparent;color:var(--muted);border-color:var(--border);}
.btn-ghost:hover{color:var(--text);border-color:var(--border2);}
.btn-danger{background:rgba(158,61,58,.08);color:var(--danger);border-color:rgba(158,61,58,.3);}
.btn-danger:hover{background:rgba(158,61,58,.15);}
.btn-google{width:100%;display:flex;align-items:center;justify-content:center;gap:10px;padding:10px 18px;border:1px solid var(--border);border-radius:6px;background:var(--surface2);font-family:'Outfit',sans-serif;font-size:13px;font-weight:500;color:var(--text);cursor:pointer;transition:all .15s;}
.btn-google:hover{border-color:var(--border2);}
.btn-sm{padding:7px 14px;font-size:12px;}
.btn-full{width:100%;}

/* NAV */
.topnav{position:sticky;top:0;z-index:50;display:flex;align-items:center;justify-content:space-between;padding:0 32px;height:60px;background:var(--surface);border-bottom:1px solid var(--border);}
.nav-brand{display:flex;align-items:center;}
.nav-right{display:flex;align-items:center;gap:12px;}
.nav-vault-label{font-size:12px;color:var(--muted);font-weight:500;display:none;}
.nav-vault-label span{color:var(--text);font-weight:600;}

/* USER MENU */
.user-menu-wrap{position:relative;}
.user-menu-btn{display:flex;align-items:center;gap:8px;padding:6px 12px 6px 6px;border-radius:20px;border:1px solid var(--border);background:var(--surface2);cursor:pointer;transition:all .15s;font-family:'Outfit',sans-serif;}
.user-menu-btn:hover{border-color:var(--border2);background:var(--surface);}
.user-avatar{width:26px;height:26px;border-radius:50%;background:var(--accent);color:#faf6ef;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;}
.user-menu-name{font-size:12px;font-weight:500;color:var(--text);max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.user-menu-chevron{color:var(--faint);transition:transform .2s;}
.user-menu-btn.open .user-menu-chevron{transform:rotate(180deg);}
.user-dropdown{position:absolute;top:calc(100% + 8px);right:0;width:240px;background:var(--surface);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 28px rgba(30,26,20,.13);z-index:100;display:none;animation:rowIn .15s ease;overflow:hidden;}
.user-dropdown.open{display:block;}
.user-dropdown-header{padding:16px 16px 12px;border-bottom:1px solid var(--border);background:var(--surface2);}
.user-dropdown-name{font-size:13px;font-weight:600;color:var(--text);}
.user-dropdown-email{font-size:11px;color:var(--muted);margin-top:2px;word-break:break-all;}
.user-dropdown-item{display:flex;align-items:center;gap:10px;padding:10px 16px;font-size:13px;color:var(--muted);cursor:pointer;transition:background .1s;border:none;background:transparent;width:100%;font-family:'Outfit',sans-serif;text-align:left;}
.user-dropdown-item:hover{background:var(--surface2);color:var(--text);}
.user-dropdown-item.danger{color:var(--danger);}
.user-dropdown-item.danger:hover{background:rgba(158,61,58,.05);}
.user-dropdown-divider{height:1px;background:var(--border);margin:4px 0;}
.user-dropdown-icon{width:16px;text-align:center;font-size:14px;flex-shrink:0;}
.nav-date{font-size:12px;color:var(--faint);}

/* ‚îÄ‚îÄ VAULT DASHBOARD ‚îÄ‚îÄ */
#dashboard-screen{display:none;}
#dashboard-screen.show{display:block;}
.dash-page{max-width:1080px;margin:0 auto;padding:40px 32px 80px;}
.dash-header{margin-bottom:36px;}
.dash-header h1{font-family:'Playfair Display',serif;font-size:30px;font-weight:400;color:var(--text);}
.dash-header h1 span{color:var(--accent);font-style:italic;}
.dash-header p{font-size:13px;color:var(--muted);font-weight:300;margin-top:6px;}
.vault-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px;}
.vault-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:24px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;}
.vault-card:hover{border-color:var(--border2);box-shadow:0 4px 20px rgba(30,26,20,.08);transform:translateY(-2px);}
.vault-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--accent);opacity:0;transition:opacity .2s;}
.vault-card:hover::before{opacity:1;}
.vault-card.shared-card::before{background:var(--ok);}
.vault-card.new-card{border-style:dashed;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;min-height:160px;color:var(--muted);}
.vault-card.new-card:hover{color:var(--accent);border-color:var(--accent);}
.vault-card-icon{width:40px;height:40px;border-radius:8px;background:rgba(107,83,53,.1);display:flex;align-items:center;justify-content:center;font-size:18px;margin-bottom:12px;}
.vault-card.shared-card .vault-card-icon{background:rgba(46,107,80,.1);}
.vault-card-name{font-size:16px;font-weight:600;color:var(--text);margin-bottom:4px;}
.vault-card-meta{font-size:12px;color:var(--muted);}
.vault-card-stats{display:flex;gap:16px;margin-top:16px;padding-top:16px;border-top:1px solid var(--border);}
.vault-stat{font-size:11px;color:var(--faint);}
.vault-stat strong{display:block;font-size:18px;font-weight:600;color:var(--text);margin-bottom:1px;}
.vault-stat.stat-danger strong{color:var(--danger);}
.vault-stat.stat-warn strong{color:var(--warn);}
.vault-role-badge{position:absolute;top:14px;right:14px;padding:3px 9px;border-radius:20px;font-size:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;}
.badge-owner{background:rgba(107,83,53,.1);color:var(--accent);}
.badge-editor{background:rgba(46,107,80,.1);color:var(--ok);}
.badge-viewer{background:rgba(184,173,158,.2);color:var(--muted);}
.new-card-plus{width:44px;height:44px;border-radius:50%;border:2px dashed currentColor;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:300;}
.new-card-label{font-size:13px;font-weight:500;}

/* ‚îÄ‚îÄ VAULT VIEW ‚îÄ‚îÄ */
#vault-screen{display:none;}
#vault-screen.show{display:block;}
.page{max-width:1080px;margin:0 auto;padding:32px 32px 80px;}
.page-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:28px;}
.page-header h1{font-family:'Playfair Display',serif;font-size:28px;font-weight:400;}
.page-header h1 span{color:var(--accent);font-style:italic;}
.page-subtitle{font-size:13px;color:var(--muted);font-weight:300;margin-top:4px;}
.btn-add-license{display:flex;align-items:center;gap:10px;padding:12px 24px;border-radius:7px;background:var(--accent);color:#faf6ef;border:none;font-family:'Outfit',sans-serif;font-size:13px;font-weight:500;cursor:pointer;letter-spacing:.3px;transition:all .2s;box-shadow:0 2px 8px rgba(107,83,53,.25);}
.btn-add-license:hover{background:var(--accent-h);box-shadow:0 4px 16px rgba(107,83,53,.3);transform:translateY(-1px);}
.btn-add-license:active{transform:translateY(0);}
.btn-add-license:disabled{opacity:.5;cursor:not-allowed;transform:none;}
.btn-add-icon{width:22px;height:22px;border-radius:50%;background:rgba(255,255,255,.18);display:flex;align-items:center;justify-content:center;flex-shrink:0;}

/* KPIs */
.kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px;}
.kpi{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:18px 20px;position:relative;overflow:hidden;}
.kpi-indicator{position:absolute;top:0;left:0;right:0;height:3px;background:var(--border);}
.kpi-danger .kpi-indicator{background:var(--danger);}
.kpi-warn .kpi-indicator{background:var(--warn);}
.kpi-ok .kpi-indicator{background:var(--ok);}
.kpi-label{font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--faint);margin-bottom:8px;}
.kpi-value{font-size:32px;font-weight:600;color:var(--text);line-height:1;}
.kpi-sub{font-size:11px;color:var(--muted);margin-top:4px;}

/* FORM */
.form-panel{background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:24px;overflow:hidden;max-height:0;transition:max-height .4s ease,opacity .3s ease;opacity:0;}
.form-panel.open{max-height:800px;opacity:1;}
.form-panel-header{padding:16px 24px;font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--faint);border-bottom:1px solid var(--border);background:var(--surface2);}
.form-body{padding:24px;}
.form-grid{display:grid;gap:16px;margin-bottom:16px;}
.fg-2{grid-template-columns:1fr 1fr;}
.fg-3{grid-template-columns:1fr 1fr 1fr;}
.field label{display:block;font-size:11px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.field input,.field select{width:100%;padding:9px 12px;border:1px solid var(--border);border-radius:5px;background:var(--bg);font-family:'Outfit',sans-serif;font-size:13px;color:var(--text);outline:none;transition:border-color .15s;}
.field input:focus,.field select:focus{border-color:var(--accent);}
.chips-group label{display:block;font-size:11px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;color:var(--muted);margin-bottom:10px;}
.chips{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px;}
.chip{padding:6px 14px;border-radius:20px;border:1px solid var(--border);font-size:12px;font-weight:500;color:var(--muted);cursor:pointer;transition:all .15s;background:var(--bg);}
.chip.on{background:var(--accent);color:#faf6ef;border-color:var(--accent);}
.form-actions{display:flex;gap:10px;}

/* TOOLBAR */
.toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.toolbar-left{font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--faint);}
.toolbar-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.search-wrap{position:relative;display:flex;align-items:center;}
.search-icon{position:absolute;left:11px;width:14px;height:14px;color:var(--faint);pointer-events:none;flex-shrink:0;}
.search-input{padding:8px 14px 8px 32px;border:1px solid var(--border);border-radius:6px;background:var(--surface);font-family:'Outfit',sans-serif;font-size:12px;color:var(--text);outline:none;transition:border-color .15s,box-shadow .15s;width:240px;}
.search-input::placeholder{color:var(--faint);}
.search-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(107,83,53,.08);}
.filter-group{display:flex;border:1px solid var(--border);border-radius:6px;overflow:hidden;}
.filter-btn{padding:7px 14px;border:none;border-right:1px solid var(--border);background:var(--surface);color:var(--muted);font-family:'Outfit',sans-serif;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;letter-spacing:.5px;text-transform:uppercase;white-space:nowrap;}
.filter-btn:last-child{border-right:none;}
.filter-btn:hover:not(.active){background:var(--surface2);color:var(--text);}
.filter-btn.active{background:var(--accent);color:#faf6ef;}
.row-count-badge{font-size:11px;color:var(--faint);font-weight:500;background:var(--surface2);border:1px solid var(--border);padding:4px 10px;border-radius:20px;white-space:nowrap;}

/* TABLE */
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-bottom:24px;}
.table-head{display:grid;grid-template-columns:32px 2fr .8fr 1fr .7fr .7fr 1.1fr 230px;padding:12px 20px;background:var(--surface2);border-bottom:1px solid var(--border);font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--faint);}
.table-row{display:grid;grid-template-columns:32px 2fr .8fr 1fr .7fr .7fr 1.1fr 230px;padding:14px 20px;border-bottom:1px solid var(--border);align-items:center;transition:background .15s;animation:rowIn .25s ease both;min-height:60px;}
.table-row:last-child{border-bottom:none;}
.table-row:hover{background:rgba(107,83,53,.025);}
.table-row.row-selected{background:rgba(107,83,53,.06)!important;}
.row-expired{background:rgba(158,61,58,.03)!important;}
.row-critical{background:rgba(158,61,58,.02)!important;}
.row-warning{background:rgba(158,106,42,.02)!important;}
@keyframes rowIn{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:none;}}
.row-name{font-weight:600;font-size:13px;color:var(--text);}
.row-vendor{font-size:11px;color:var(--muted);margin-top:2px;}
.row-cell{font-size:13px;color:var(--muted);}
.row-cost{font-size:13px;color:var(--text);font-weight:500;}
.row-actions{display:flex;align-items:center;justify-content:flex-end;gap:4px;}
.status-tag{display:inline-flex;align-items:center;gap:5px;padding:4px 11px;border-radius:6px;font-size:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;}
.tag-ok{background:rgba(46,107,80,.08);color:var(--ok);}
.tag-warning{background:rgba(158,106,42,.08);color:var(--warn);}
.tag-critical,.tag-expired{background:rgba(158,61,58,.08);color:var(--danger);}
.tag-dot{width:5px;height:5px;border-radius:50%;background:currentColor;}
.days-count{font-size:10px;font-weight:500;letter-spacing:.2px;padding-left:2px;}
.status-cell{display:flex;flex-direction:column;align-items:flex-start;gap:5px;}
.c-ok{color:var(--ok);} .c-warn{color:var(--warn);} .c-danger{color:var(--danger);}
.table-empty{padding:48px;text-align:center;color:var(--faint);font-size:13px;}
.btn-icon{padding:6px 11px;border-radius:5px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'Outfit',sans-serif;font-size:11px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:5px;transition:all .15s;letter-spacing:.3px;white-space:nowrap;}
.btn-icon:hover{border-color:var(--border2);color:var(--text);background:var(--surface2);}
.btn-icon.btn-edit:hover{border-color:var(--accent);color:var(--accent);background:rgba(107,83,53,.06);}
.btn-icon.btn-delete:hover{border-color:var(--danger);color:var(--danger);background:rgba(158,61,58,.06);}
.btn-icon.btn-comment:hover{border-color:var(--faint);color:var(--text);background:var(--surface2);}
.btn-renew{padding:6px 11px;border-radius:5px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'Outfit',sans-serif;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;letter-spacing:.3px;white-space:nowrap;display:inline-flex;align-items:center;gap:5px;}
.btn-renew:hover{border-color:var(--ok);color:var(--ok);background:rgba(46,107,80,.06);}
.btn-renew.renewed{background:var(--ok);color:#fff;border-color:var(--ok);animation:renewPop .4s ease;}
@keyframes renewPop{0%{transform:scale(1);}40%{transform:scale(1.12);}100%{transform:scale(1);}}

/* SETTINGS */
.settings-panel{background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:visible;margin-bottom:24px;}
.settings-panel-header{padding:14px 24px;font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--faint);border-bottom:1px solid var(--border);background:var(--surface2);border-radius:8px 8px 0 0;display:flex;align-items:center;justify-content:space-between;}
.settings-body{padding:24px;}

/* REMINDER DROPDOWN */
.reminder-dropdown-wrap{position:relative;}
.reminder-dropdown-trigger{width:100%;display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border:1px solid var(--border);border-radius:6px;background:var(--bg);font-family:'Outfit',sans-serif;font-size:13px;color:var(--text);cursor:pointer;transition:border-color .15s;text-align:left;}
.reminder-dropdown-trigger:hover{border-color:var(--border2);}
.reminder-dropdown-trigger.open{border-color:var(--accent);box-shadow:0 0 0 3px rgba(107,83,53,.08);}
.reminder-dropdown-trigger.open #reminder-chevron{transform:rotate(180deg);}
.reminder-dropdown-menu{position:absolute;top:calc(100% + 6px);left:0;right:0;background:var(--surface);border:1px solid var(--border);border-radius:8px;box-shadow:0 8px 24px rgba(30,26,20,.12);z-index:100;display:none;animation:rowIn .15s ease;}
.reminder-dropdown-menu.open{display:block;}
.reminder-dropdown-label{padding:10px 14px 8px;font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--faint);border-bottom:1px solid var(--border);}
.reminder-option{display:flex;align-items:center;gap:10px;padding:10px 14px;font-size:13px;color:var(--muted);cursor:pointer;transition:background .1s;user-select:none;}
.reminder-option:hover{background:var(--surface2);color:var(--text);}
.reminder-check{width:18px;height:18px;border-radius:4px;border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;color:transparent;transition:all .15s;flex-shrink:0;background:var(--bg);}
.reminder-check.active{background:var(--accent);border-color:var(--accent);color:#faf6ef;}

/* MEMBERS */
.btn-invite{display:flex;align-items:center;gap:7px;padding:7px 14px;border-radius:5px;background:var(--accent);color:#faf6ef;border:none;font-family:'Outfit',sans-serif;font-size:11px;font-weight:600;cursor:pointer;letter-spacing:.3px;transition:background .15s;}
.btn-invite:hover{background:var(--accent-h);}
.members-empty{font-size:12px;color:var(--faint);text-align:center;padding:24px 0;font-style:italic;}
.member-row{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);}
.member-row:last-child{border-bottom:none;}
.member-avatar{width:34px;height:34px;border-radius:50%;background:var(--accent);color:#faf6ef;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;flex-shrink:0;}
.member-info{flex:1;min-width:0;}
.member-email{font-size:13px;font-weight:500;color:var(--text);}
.member-meta{font-size:11px;color:var(--faint);margin-top:1px;}
.member-badge{padding:3px 9px;border-radius:20px;font-size:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;}
.badge-viewer{background:rgba(107,83,53,.1);color:var(--accent);}
.badge-editor-m{background:rgba(46,107,80,.1);color:var(--ok);}
.badge-pending{background:rgba(158,106,42,.1);color:var(--warn);}
.member-remove{padding:4px 8px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--faint);font-size:11px;cursor:pointer;transition:all .15s;font-family:'Outfit',sans-serif;}
.member-remove:hover{border-color:var(--danger);color:var(--danger);}

/* ROLE SELECTOR */
.role-selector{display:flex;flex-direction:column;gap:8px;}
.role-option{display:flex;align-items:center;gap:14px;padding:12px 16px;border:1.5px solid var(--border);border-radius:7px;cursor:pointer;transition:all .15s;background:var(--bg);}
.role-option:hover{border-color:var(--border2);}
.role-option.active{border-color:var(--accent);background:rgba(107,83,53,.04);}
.role-icon{font-size:18px;flex-shrink:0;width:28px;text-align:center;}
.role-check{margin-left:auto;width:20px;height:20px;border-radius:50%;border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;color:transparent;transition:all .15s;flex-shrink:0;}
.role-option.active .role-check{background:var(--accent);border-color:var(--accent);color:#faf6ef;}

/* MODALS */
.overlay{position:fixed;inset:0;background:rgba(30,26,20,.4);backdrop-filter:blur(2px);z-index:200;display:flex;align-items:center;justify-content:center;padding:24px;opacity:0;pointer-events:none;transition:opacity .2s;}
.overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:10px;width:100%;max-width:460px;box-shadow:0 20px 60px rgba(30,26,20,.2);transform:translateY(8px);transition:transform .2s;}
.overlay.open .modal{transform:none;}
.modal-header{padding:24px 24px 16px;}
.modal-header h3{font-family:'Playfair Display',serif;font-size:20px;font-weight:400;}
.modal-body{padding:4px 24px 16px;}
.modal-footer{padding:16px 24px 24px;display:flex;gap:10px;}

/* TOAST */
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(16px);background:var(--text);color:#faf6ef;padding:10px 20px;border-radius:6px;font-size:13px;font-weight:500;z-index:500;opacity:0;transition:all .25s;pointer-events:none;white-space:nowrap;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* FOOTER */
.footer{text-align:center;padding:24px;font-size:11px;color:var(--faint);border-top:1px solid var(--border);}
.footer span{margin:0 6px;}

/* HIDDEN */
.hidden{display:none!important;}

/* NAV INSIGHTS BUTTON */
.nav-insights-btn{display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'Outfit',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;letter-spacing:.3px;}
.nav-insights-btn:hover{color:var(--text);border-color:var(--border2);}
.nav-insights-btn.active{background:var(--accent);color:#faf6ef;border-color:var(--accent);}

/* INSIGHTS SCREEN */
#insights-screen{display:none;}
#insights-screen.show{display:block;}
.insights-page{max-width:1080px;margin:0 auto;padding:36px 32px 80px;}
.insights-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:32px;flex-wrap:wrap;gap:12px;}
.insights-header h1{font-family:'Playfair Display',serif;font-size:28px;font-weight:400;}
.insights-header h1 span{color:var(--accent);font-style:italic;}
.insights-vault-selector{display:flex;gap:6px;flex-wrap:wrap;}
.insights-vault-btn{padding:6px 14px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'Outfit',sans-serif;font-size:11px;font-weight:600;cursor:pointer;transition:all .15s;}
.insights-vault-btn:hover{border-color:var(--border2);color:var(--text);}
.insights-vault-btn.active{background:var(--accent);color:#faf6ef;border-color:var(--accent);}

/* SPENDING CARDS */
.spend-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px;}
.spend-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:20px 22px;position:relative;overflow:hidden;}
.spend-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--accent);}
.spend-card-label{font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--faint);margin-bottom:8px;}
.spend-card-value{font-size:28px;font-weight:600;color:var(--text);line-height:1;}
.spend-card-sub{font-size:11px;color:var(--muted);margin-top:4px;}

/* INSIGHTS PANELS */
.insights-row{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;}
.insights-panel{background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden;}
.insights-panel.full{grid-column:1/-1;}
.insights-panel-header{padding:14px 20px;font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--faint);border-bottom:1px solid var(--border);background:var(--surface2);}
.insights-panel-body{padding:20px;}

/* CATEGORY CHART */
.cat-bar-row{display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.cat-bar-row:last-child{margin-bottom:0;}
.cat-bar-label{font-size:12px;color:var(--text);font-weight:500;width:110px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.cat-bar-track{flex:1;height:8px;border-radius:4px;background:var(--surface2);border:1px solid var(--border);overflow:hidden;}
.cat-bar-fill{height:100%;border-radius:4px;background:var(--accent);transition:width .6s ease;}
.cat-bar-val{font-size:11px;color:var(--muted);width:60px;text-align:right;flex-shrink:0;}

/* CALENDAR */
.cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.cal-title{font-size:15px;font-weight:600;color:var(--text);}
.cal-nav{display:flex;gap:6px;}
.cal-nav-btn{width:28px;height:28px;border-radius:5px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .15s;}
.cal-nav-btn:hover{border-color:var(--border2);color:var(--text);}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;}
.cal-day-name{font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--faint);text-align:center;padding:4px 0 8px;}
.cal-day{min-height:52px;border-radius:5px;padding:4px;position:relative;cursor:default;transition:background .1s;}
.cal-day.empty{background:transparent;}
.cal-day.today{background:rgba(107,83,53,.06);outline:1px solid var(--accent);}
.cal-day-num{font-size:10px;font-weight:600;color:var(--muted);margin-bottom:2px;}
.cal-day.today .cal-day-num{color:var(--accent);}
.cal-dot{font-size:9px;line-height:1.3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border-radius:2px;padding:1px 3px;margin-bottom:1px;}
.cal-dot.dot-expired{background:rgba(158,61,58,.12);color:var(--danger);}
.cal-dot.dot-warn{background:rgba(158,106,42,.1);color:var(--warn);}
.cal-dot.dot-ok{background:rgba(46,107,80,.08);color:var(--ok);}

/* UPCOMING LIST */
.upcoming-item{display:flex;align-items:center;gap:12px;padding:11px 0;border-bottom:1px solid var(--border);}
.upcoming-item:last-child{border-bottom:none;}
.upcoming-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.upcoming-name{font-size:13px;font-weight:500;color:var(--text);flex:1;}
.upcoming-vault{font-size:11px;color:var(--faint);}
.upcoming-date{font-size:12px;color:var(--muted);text-align:right;}
.upcoming-days{font-size:11px;font-weight:600;text-align:right;}

@media(max-width:768px){
  .spend-grid{grid-template-columns:1fr 1fr;}
  .insights-row{grid-template-columns:1fr;}
}


/* ACTIVITY LOG */
.activity-list{max-height:340px;overflow-y:auto;}
.activity-item{display:flex;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);}
.activity-item:last-child{border-bottom:none;}
.activity-icon{width:28px;height:28px;border-radius:50%;background:var(--surface2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;margin-top:1px;}
.activity-body{flex:1;min-width:0;}
.activity-text{font-size:12px;color:var(--text);line-height:1.5;}
.activity-text strong{font-weight:600;}
.activity-meta{font-size:11px;color:var(--faint);margin-top:2px;}
.activity-empty{font-size:12px;color:var(--faint);font-style:italic;text-align:center;padding:24px 0;}

/* COMMENTS */
.comment-thread{margin-top:0;}
.comment-item{display:flex;gap:10px;padding:12px 0;border-bottom:1px solid var(--border);}
.comment-item:last-child{border-bottom:none;}
.comment-avatar{width:28px;height:28px;border-radius:50%;background:var(--accent);color:#faf6ef;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;}
.comment-body{flex:1;min-width:0;}
.comment-header{display:flex;align-items:baseline;gap:8px;margin-bottom:3px;}
.comment-author{font-size:12px;font-weight:600;color:var(--text);}
.comment-time{font-size:10px;color:var(--faint);}
.comment-text{font-size:13px;color:var(--text);line-height:1.5;}
.comment-text .mention{color:var(--accent);font-weight:600;}
.comment-delete{margin-left:auto;padding:2px 6px;border-radius:3px;border:none;background:transparent;color:var(--faint);font-size:10px;cursor:pointer;transition:color .1s;flex-shrink:0;}
.comment-delete:hover{color:var(--danger);}
.comment-input-wrap{display:flex;gap:8px;margin-top:12px;align-items:flex-end;}
.comment-input{flex:1;padding:9px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);font-family:'Outfit',sans-serif;font-size:13px;color:var(--text);outline:none;resize:none;min-height:38px;transition:border-color .15s;}
.comment-input:focus{border-color:var(--accent);}
.comment-submit{padding:9px 16px;border-radius:6px;border:none;background:var(--accent);color:#faf6ef;font-family:'Outfit',sans-serif;font-size:12px;font-weight:600;cursor:pointer;flex-shrink:0;transition:background .15s;}
.comment-submit:hover{background:var(--accent-h);}
.mention-hint{font-size:10px;color:var(--faint);margin-top:4px;}

/* LICENSE ROW COMMENT INDICATOR */
.comment-badge{display:inline-flex;align-items:center;gap:3px;font-size:10px;color:var(--faint);padding:2px 6px;border-radius:3px;background:var(--surface2);border:1px solid var(--border);}

/* TRANSFER OWNERSHIP */
.transfer-section{margin-top:16px;padding-top:16px;border-top:1px solid var(--border);}
.transfer-label{font-size:11px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;color:var(--faint);margin-bottom:10px;}

/* DARK MODE TOGGLE */
.dark-toggle{width:36px;height:20px;border-radius:10px;background:var(--border);border:none;cursor:pointer;position:relative;transition:background .2s;flex-shrink:0;}
.dark-toggle::after{content:'';position:absolute;top:2px;left:2px;width:16px;height:16px;border-radius:50%;background:var(--surface);transition:transform .2s,background .2s;box-shadow:0 1px 3px rgba(0,0,0,.2);}
[data-theme="dark"] .dark-toggle{background:var(--accent);}
[data-theme="dark"] .dark-toggle::after{transform:translateX(16px);}

/* BULK ACTIONS */
.bulk-bar{display:none;align-items:center;gap:12px;padding:10px 20px;background:var(--accent);color:#faf6ef;border-radius:8px;margin-bottom:8px;animation:rowIn .2s ease;}
.bulk-bar.show{display:flex;}
.bulk-bar-count{font-size:13px;font-weight:600;flex:1;}
.bulk-btn{padding:6px 14px;border-radius:5px;border:1px solid rgba(255,255,255,.3);background:transparent;color:#faf6ef;font-family:'Outfit',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:background .15s;}
.bulk-btn:hover{background:rgba(255,255,255,.15);}
.bulk-btn.bulk-danger{border-color:rgba(255,150,140,.4);color:#ffb8b4;}
.bulk-btn.bulk-danger:hover{background:rgba(200,60,50,.25);}
.row-checkbox{width:16px;height:16px;accent-color:var(--accent);cursor:pointer;flex-shrink:0;}
.table-head-check{display:flex;align-items:center;}

/* TEMPLATES */
.templates-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-top:4px;}
.template-card{padding:12px 14px;border:1px solid var(--border);border-radius:7px;cursor:pointer;transition:all .15s;background:var(--bg);}
.template-card:hover{border-color:var(--accent);background:rgba(107,83,53,.04);}
.template-name{font-size:13px;font-weight:600;color:var(--text);}
.template-vendor{font-size:11px;color:var(--muted);margin-top:2px;}

/* DUPLICATE WARNING */
.dup-warning{display:none;background:rgba(158,106,42,.08);border:1px solid rgba(158,106,42,.3);border-radius:6px;padding:9px 14px;font-size:12px;color:var(--warn);margin-bottom:12px;}
.dup-warning.show{display:block;}

/* ARCHIVE badge */
.badge-archived{background:rgba(184,173,158,.15);color:var(--faint);}
.vault-card.archived-card{opacity:.65;}
.vault-card.archived-card::before{background:var(--faint);}

/* VAULT ACTIONS ROW on dashboard cards */
.vault-card-actions{display:flex;gap:6px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border);}
.vault-action-btn{flex:1;padding:5px 8px;border-radius:5px;border:1px solid var(--border);background:transparent;color:var(--muted);font-family:'Outfit',sans-serif;font-size:11px;font-weight:500;cursor:pointer;transition:all .15s;text-align:center;}
.vault-action-btn:hover{border-color:var(--border2);color:var(--text);}
.vault-action-btn.danger:hover{border-color:var(--danger);color:var(--danger);}

/* VAULT NAME INPUT IN MODAL */
.vault-color-grid{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
.vault-color-swatch{width:28px;height:28px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .15s;}
.vault-color-swatch.selected{border-color:var(--text);transform:scale(1.15);}

@media(max-width:768px){
  .topnav{padding:0 16px;}
  .page,.dash-page{padding:20px 16px 60px;}
  .kpi-row{grid-template-columns:1fr 1fr;}
  .table-head>*:nth-child(3),.table-head>*:nth-child(4),.table-head>*:nth-child(5),
  .table-row>*:nth-child(3),.table-row>*:nth-child(4),.table-row>*:nth-child(5){display:none;}
  .table-head,.table-row{grid-template-columns:32px 1fr auto auto;}
  .fg-3,.fg-2{grid-template-columns:1fr;}
  .vault-grid{grid-template-columns:1fr;}
}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loading-screen" class="loading-screen">
  <div style="display:flex;flex-direction:column;align-items:center;gap:16px;">
    <div class="spinner-ring"></div>
    <span class="spinner-text">Loading</span>
  </div>
</div>

<!-- AUTH -->
<div class="auth-screen hidden" id="auth-screen">
  <div class="auth-card">
    <div class="auth-header">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 44" height="44">
        <g transform="translate(20,22)">
          <circle cx="0" cy="0" r="14" fill="none" stroke="#ddd5c4" stroke-width="1"/>
          <path d="M 0,-11 A 11,11 0 1,1 -7.8,7.8" fill="none" stroke="#6b5335" stroke-width="2" stroke-linecap="round"/>
          <g transform="translate(-7.8,7.8) rotate(-40)"><polygon points="0,-3.5 -2.5,2 2.5,2" fill="#6b5335"/></g>
          <circle cx="0" cy="-11" r="1.8" fill="#6b5335"/>
        </g>
        <g transform="translate(42,0)">
          <text font-family="'Playfair Display',Georgia,serif" font-size="28" font-weight="400" y="30"><tspan fill="#6b5335" font-style="italic">re-</tspan><tspan fill="#1e1a14">newly</tspan></text>
          <line x1="1" y1="36" x2="188" y2="36" stroke="#ddd5c4" stroke-width="0.8"/>
          <text x="2" y="44" font-family="'Outfit',sans-serif" font-size="7.5" font-weight="500" fill="#b8ad9e" letter-spacing="3.5">LICENSE TRACKER</text>
        </g>
      </svg>
    </div>
    <div class="auth-body">
      <div class="auth-tabs">
        <button class="auth-tab active" id="tab-login" onclick="switchTab('login')">Sign In</button>
        <button class="auth-tab" id="tab-signup" onclick="switchTab('signup')">Create Account</button>
      </div>
      <div class="auth-error" id="auth-error"></div>
      <div class="auth-field"><label>Email</label><input type="email" id="auth-email" placeholder="you@company.com"></div>
      <div class="auth-field"><label>Password</label><input type="password" id="auth-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      <button class="btn btn-primary btn-full" id="auth-submit-btn" onclick="submitAuth()">Sign In</button>
      <div class="auth-divider">or</div>
      <button class="btn-google" onclick="signInWithGoogle()">
        <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 0 0 9 18z"/><path fill="#FBBC05" d="M3.964 10.707A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.707V4.961H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.039l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.961L3.964 6.293C4.672 4.166 6.656 3.58 9 3.58z"/></svg>
        Continue with Google
      </button>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app-screen" class="hidden">
  <nav class="topnav">
    <div class="nav-brand" onclick="goToDashboard()" style="cursor:pointer;" title="Back to vaults">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 50" height="38" style="display:block">
        <g transform="translate(22,25)">
          <circle cx="0" cy="0" r="16" fill="none" stroke="var(--border)" stroke-width="1"/>
          <path d="M 0,-13 A 13,13 0 1,1 -9.2,9.2" fill="none" stroke="var(--accent)" stroke-width="2" stroke-linecap="round"/>
          <g transform="translate(-9.2,9.2) rotate(-40)"><polygon points="0,-4 -3,2.5 3,2.5" fill="var(--accent)"/></g>
          <circle cx="0" cy="-13" r="2" fill="var(--accent)"/>
        </g>
        <g transform="translate(46,0)">
          <text font-family="'Playfair Display',Georgia,serif" font-size="26" font-weight="400" y="30"><tspan fill="var(--accent)" font-style="italic">re-</tspan><tspan fill="var(--text)">newly</tspan></text>
          <line x1="1" y1="36" x2="194" y2="36" stroke="var(--border)" stroke-width="0.8"/>
          <text x="2" y="47" font-family="'Outfit',sans-serif" font-size="8" font-weight="500" fill="var(--faint)" letter-spacing="3.5">LICENSE TRACKER</text>
        </g>
      </svg>
    </div>
    <div class="nav-right">
      <button class="nav-insights-btn" id="nav-insights-btn" onclick="_openInsights()">
        <svg viewBox="0 0 16 16" fill="none" width="14" height="14"><rect x="1" y="8" width="3" height="6" rx="1" fill="currentColor"/><rect x="6.5" y="4" width="3" height="10" rx="1" fill="currentColor"/><rect x="12" y="1" width="3" height="13" rx="1" fill="currentColor"/></svg>
        Insights
      </button>
      <span class="nav-date" id="nav-date"></span>
      <div class="nav-vault-label" id="nav-vault-label">In vault: <span id="nav-vault-name"></span></div>
      <div class="user-menu-wrap" id="user-menu-wrap">
        <button class="user-menu-btn" id="user-menu-btn" onclick="_toggleUserMenu()">
          <div class="user-avatar" id="user-avatar">?</div>
          <span class="user-menu-name" id="user-menu-name"></span>
          <svg class="user-menu-chevron" viewBox="0 0 16 16" fill="none" width="12" height="12"><path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
        <div class="user-dropdown" id="user-dropdown">
          <div class="user-dropdown-header">
            <div class="user-dropdown-name" id="dd-name"></div>
            <div class="user-dropdown-email" id="dd-email"></div>
          </div>
          <div style="padding:4px 0">
            <button class="user-dropdown-item" onclick="_openAccountModal()"><span class="user-dropdown-icon">üë§</span> Account Details</button>
            <button class="user-dropdown-item" onclick="_openResetPasswordModal()"><span class="user-dropdown-icon">üîë</span> Reset Password</button>
            <div class="user-dropdown-item" onclick="_toggleDark()" style="justify-content:space-between;cursor:pointer;">
              <span style="display:flex;align-items:center;gap:10px"><span class="user-dropdown-icon">üåô</span> Dark Mode</span>
              <div class="dark-toggle" id="dark-toggle"></div>
            </div>
            <div class="user-dropdown-divider"></div>
            <button class="user-dropdown-item danger" onclick="_signOut()"><span class="user-dropdown-icon">‚Ü©</span> Sign Out</button>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- DASHBOARD SCREEN -->
  <div id="dashboard-screen" class="show">
    <div class="dash-page">
      <div class="dash-header">
        <h1>Your <span>Vaults</span></h1>
        <p>Select a vault to manage licenses, or create a new one.</p>
      </div>
      <div class="vault-grid" id="vault-grid">
        <!-- populated by JS -->
      </div>
    </div>
  </div>

  <!-- VAULT SCREEN -->
  <div id="vault-screen">
    <div class="page">
      <div class="page-header">
        <div>
          <h1 id="vault-title">Vault</h1>
          <p class="page-subtitle" id="vault-subtitle"></p>
        </div>
        <button class="btn-add-license" id="add-license-btn" onclick="_toggleForm()">
          <span class="btn-add-icon">
            <svg viewBox="0 0 16 16" fill="none" width="14" height="14"><path d="M8 2v12M2 8h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </span>
          Add License
        </button>
      </div>

      <div class="kpi-row">
        <div class="kpi"><div class="kpi-indicator"></div><div class="kpi-label">Total</div><div class="kpi-value" id="k-total">0</div><div class="kpi-sub">licenses tracked</div></div>
        <div class="kpi kpi-danger"><div class="kpi-indicator"></div><div class="kpi-label">Expired</div><div class="kpi-value" id="k-expired">0</div><div class="kpi-sub">action required</div></div>
        <div class="kpi kpi-warn"><div class="kpi-indicator"></div><div class="kpi-label">Expiring Soon</div><div class="kpi-value" id="k-warn">0</div><div class="kpi-sub">within 30 days</div></div>
        <div class="kpi kpi-ok"><div class="kpi-indicator"></div><div class="kpi-label">Active</div><div class="kpi-value" id="k-ok">0</div><div class="kpi-sub">in good standing</div></div>
      </div>

      <div class="form-panel" id="add-form">
        <div class="form-panel-header">New License Entry</div>
        <div class="form-body">
          <!-- TEMPLATES -->
          <div style="margin-bottom:16px">
            <div style="font-size:11px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;">Quick Templates</div>
            <div class="templates-grid" id="templates-grid"></div>
          </div>

          <div class="dup-warning" id="dup-warning">‚ö† A license with a similar name already exists ‚Äî check below before adding.</div>

          <div class="form-grid fg-3">
            <div class="field"><label>License Name *</label><input id="f-name" placeholder="e.g. Adobe Creative Cloud" oninput="_checkDuplicate()"></div>
            <div class="field"><label>Vendor</label><input id="f-vendor" placeholder="e.g. Adobe Inc."></div>
            <div class="field"><label>Category</label><select id="f-cat"><option>Software</option><option>SaaS</option><option>Domain</option><option>SSL / Security</option><option>Hardware</option><option>Other</option></select></div>
          </div>
          <div class="form-grid fg-3">
            <div class="field"><label>Expiration Date *</label><input type="date" id="f-expiry"></div>
            <div class="field"><label>Annual Cost</label><input id="f-cost" placeholder="e.g. $299 / year"></div>
            <div class="field"><label>Seats / Licenses</label><input type="number" id="f-seats" placeholder="e.g. 10" min="1"></div>
          </div>
          <div class="chips-group"><label>Reminder Intervals</label>
            <div class="chips" id="form-chips">
              <div class="chip" data-d="90">90 days</div><div class="chip on" data-d="60">60 days</div><div class="chip on" data-d="30">30 days</div>
              <div class="chip" data-d="14">14 days</div><div class="chip on" data-d="7">7 days</div><div class="chip" data-d="3">3 days</div><div class="chip" data-d="1">1 day</div>
            </div>
          </div>
          <div class="field" style="margin-bottom:22px"><label>Internal Notes</label><input id="f-notes" placeholder="Seat count, account owner, renewal contact‚Ä¶"></div>
          <div class="form-actions">
            <button class="btn btn-primary" onclick="_addLicense()">Save Entry</button>
            <button class="btn btn-ghost" onclick="_saveAsTemplate()" title="Save current form as a reusable template">‚≠ê Save as Template</button>
            <button class="btn btn-ghost" onclick="_toggleForm()">Discard</button>
          </div>
        </div>
      </div>

      <div class="bulk-bar" id="bulk-bar">
        <span class="bulk-bar-count" id="bulk-count">0 selected</span>
        <button class="bulk-btn" onclick="_bulkExportCSV()">‚¨á Export CSV</button>
        <button class="bulk-btn bulk-danger" onclick="_bulkDelete()">‚úï Delete Selected</button>
        <button class="bulk-btn" onclick="_clearBulk()">‚úï Cancel</button>
      </div>

      <div class="toolbar">
        <span class="toolbar-left">Licenses</span>
        <div class="toolbar-right">
          <div class="search-wrap">
            <svg class="search-icon" viewBox="0 0 16 16" fill="none"><circle cx="6.5" cy="6.5" r="4.5" stroke="currentColor" stroke-width="1.4"/><path d="M10 10L13.5 13.5" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/></svg>
            <input id="search-input" class="search-input" placeholder="Search by name, vendor, category‚Ä¶" oninput="_filterLicenses()">
          </div>
          <div class="filter-group">
            <button class="filter-btn active" data-filter="all" onclick="_setFilter('all',this)">All</button>
            <button class="filter-btn" data-filter="expired" onclick="_setFilter('expired',this)">Expired</button>
            <button class="filter-btn" data-filter="expiring" onclick="_setFilter('expiring',this)">Expiring</button>
            <button class="filter-btn" data-filter="active" onclick="_setFilter('active',this)">Active</button>
          </div>
          <span class="row-count-badge" id="row-count"></span>
          <button class="btn btn-ghost btn-sm" onclick="_exportCSV()" title="Export vault to CSV" style="white-space:nowrap">‚¨á CSV</button>
        </div>
      </div>

      <div class="table-wrap">
        <div class="table-head" id="table-head">
          <div class="table-head-check"><input type="checkbox" class="row-checkbox" id="select-all" onclick="_toggleSelectAll()" title="Select all"></div>
          <div>License</div><div>Category</div><div>Expires</div>
          <div>Cost</div><div>Seats</div><div>Status</div><div style="text-align:right">Actions</div>
        </div>
        <div id="license-list"></div>
      </div>

      <!-- REMINDER SETTINGS -->
      <div class="settings-panel" id="reminder-panel">
        <div class="settings-panel-header">Reminder Settings</div>
        <div class="settings-body">
          <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:40px;flex-wrap:wrap;">
            <div style="flex:1;min-width:200px;">
              <h4 style="font-size:13px;font-weight:600;color:var(--text);margin-bottom:4px;">Reminder Schedule</h4>
              <p style="font-size:12px;color:var(--muted);font-weight:300;">Automatic emails sent at each selected interval before a license expires.</p>
            </div>
            <div style="flex:1;min-width:200px;">
              <div class="reminder-dropdown-wrap" id="reminder-dropdown-wrap">
                <button class="reminder-dropdown-trigger" id="reminder-dropdown-trigger" onclick="_toggleReminderDropdown()">
                  <span id="reminder-trigger-text">Loading‚Ä¶</span>
                  <svg style="width:14px;height:14px;transition:transform .2s;" id="reminder-chevron" viewBox="0 0 16 16" fill="none"><path d="M4 6l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <div class="reminder-dropdown-menu" id="reminder-dropdown-menu">
                  <div class="reminder-dropdown-label">Select reminder intervals</div>
                  <div class="reminder-option" data-d="90"><span class="reminder-check" id="rc-90">‚úì</span> 90 days before</div>
                  <div class="reminder-option" data-d="60"><span class="reminder-check active" id="rc-60">‚úì</span> 60 days before</div>
                  <div class="reminder-option" data-d="30"><span class="reminder-check active" id="rc-30">‚úì</span> 30 days before</div>
                  <div class="reminder-option" data-d="14"><span class="reminder-check" id="rc-14">‚úì</span> 14 days before</div>
                  <div class="reminder-option" data-d="7"><span class="reminder-check active" id="rc-7">‚úì</span> 7 days before</div>
                  <div class="reminder-option" data-d="3"><span class="reminder-check" id="rc-3">‚úì</span> 3 days before</div>
                  <div class="reminder-option" data-d="1"><span class="reminder-check" id="rc-1">‚úì</span> 1 day before</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- VAULT MEMBERS (only for owner) -->
      <div class="settings-panel" id="vault-members-panel">
        <div class="settings-panel-header">
          <span>Vault Members</span>
          <button class="btn-invite" onclick="_openInviteModal()">
            <svg viewBox="0 0 16 16" fill="none" width="13" height="13"><path d="M8 2v12M2 8h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            Invite Member
          </button>
        </div>
        <div class="settings-body">
          <p style="font-size:12px;color:var(--muted);font-weight:300;margin-bottom:16px;">Invite teammates to view or manage this vault. They'll receive an email invitation.</p>
          <div id="members-list"><div class="members-empty">No members yet. Invite someone to share this vault.</div></div>

          <div class="transfer-section" id="transfer-section">
            <div class="transfer-label">Transfer Ownership</div>
            <p style="font-size:12px;color:var(--muted);margin-bottom:12px;">Transfer this vault to an active member. You'll become an editor.</p>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <select id="transfer-select" style="flex:1;min-width:160px;padding:8px 12px;border:1px solid var(--border);border-radius:5px;background:var(--bg);font-family:'Outfit',sans-serif;font-size:13px;color:var(--text);outline:none;">
                <option value="">Select a member‚Ä¶</option>
              </select>
              <button class="btn btn-ghost btn-sm" onclick="_promptTransfer()">Transfer ‚Üí</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- INSIGHTS SCREEN -->
  <div id="insights-screen">
    <div class="insights-page">
      <div class="insights-header">
        <div>
          <h1>Spending <span>Insights</span></h1>
          <p style="font-size:13px;color:var(--muted);font-weight:300;margin-top:4px">Annual costs, renewal calendar and category breakdown across your vaults.</p>
        </div>
        <div class="insights-vault-selector" id="insights-vault-selector"></div>
      </div>

      <!-- KPI SPEND CARDS -->
      <div class="spend-grid">
        <div class="spend-card"><div class="spend-card-label">Annual Spend</div><div class="spend-card-value" id="ins-annual">‚Äî</div><div class="spend-card-sub">across selected vaults</div></div>
        <div class="spend-card"><div class="spend-card-label">Monthly Avg</div><div class="spend-card-value" id="ins-monthly">‚Äî</div><div class="spend-card-sub">per month</div></div>
        <div class="spend-card"><div class="spend-card-label">Licenses Tracked</div><div class="spend-card-value" id="ins-count">‚Äî</div><div class="spend-card-sub">with cost data</div></div>
        <div class="spend-card"><div class="spend-card-label">Renewals This Month</div><div class="spend-card-value" id="ins-thismonth">‚Äî</div><div class="spend-card-sub">expiring in 30 days</div></div>
      </div>

      <div class="insights-row">
        <!-- CATEGORY BREAKDOWN -->
        <div class="insights-panel">
          <div class="insights-panel-header">Spend by Category</div>
          <div class="insights-panel-body" id="cat-breakdown"></div>
        </div>

        <!-- UPCOMING RENEWALS LIST -->
        <div class="insights-panel">
          <div class="insights-panel-header">Upcoming Renewals</div>
          <div class="insights-panel-body" id="upcoming-list" style="max-height:320px;overflow-y:auto;padding:0 20px;"></div>
        </div>
      </div>

      <!-- RENEWAL CALENDAR -->
      <div class="insights-panel full" style="margin-bottom:20px">
        <div class="insights-panel-header" style="display:flex;align-items:center;justify-content:space-between;">
          <span>Renewal Calendar</span>
          <div style="display:flex;gap:10px;font-size:11px;color:var(--faint);">
            <span style="display:flex;align-items:center;gap:4px"><span style="width:8px;height:8px;border-radius:50%;background:var(--danger);display:inline-block"></span>Expired</span>
            <span style="display:flex;align-items:center;gap:4px"><span style="width:8px;height:8px;border-radius:50%;background:var(--warn);display:inline-block"></span>Expiring</span>
            <span style="display:flex;align-items:center;gap:4px"><span style="width:8px;height:8px;border-radius:50%;background:var(--ok);display:inline-block"></span>Active</span>
          </div>
        </div>
        <div class="insights-panel-body">
          <div class="cal-header">
            <div class="cal-title" id="cal-title"></div>
            <div class="cal-nav">
              <button class="cal-nav-btn" onclick="_calPrev()">‚Äπ</button>
              <button class="cal-nav-btn" onclick="_calToday()">Today</button>
              <button class="cal-nav-btn" onclick="_calNext()">‚Ä∫</button>
            </div>
          </div>
          <div class="cal-grid" id="cal-grid"></div>
        </div>
      </div>

      <!-- ACTIVITY LOG (owner + editors) -->
      <div class="settings-panel" id="activity-panel" style="display:none">
        <div class="settings-panel-header">Activity Log</div>
        <div class="settings-body">
          <div class="activity-list" id="activity-list">
            <div class="activity-empty">No activity yet.</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <footer class="footer">¬© 2026 Karam Al-Ramahi <span>¬∑</span> re-newly</footer>
</div>

<!-- CREATE VAULT MODAL -->
<div class="overlay" id="create-vault-modal">
  <div class="modal">
    <div class="modal-header"><h3>Create New Vault</h3></div>
    <div class="modal-body">
      <div class="field" style="margin-bottom:16px">
        <label>Vault Name *</label>
        <input id="cv-name" placeholder="e.g. Work Licenses, Client A, Personal">
      </div>
      <div class="field" style="margin-bottom:4px">
        <label>Description</label>
        <input id="cv-desc" placeholder="Optional ‚Äî what this vault is for">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="_confirmCreateVault()">Create Vault</button>
      <button class="btn btn-ghost" onclick="_closeCreateVaultModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- INVITE MODAL -->
<div class="overlay" id="invite-modal">
  <div class="modal">
    <div class="modal-header">
      <h3>Invite Member</h3>
      <p style="font-size:13px;color:var(--muted);font-weight:300;margin-top:6px">They'll receive an email invitation to this vault.</p>
    </div>
    <div class="modal-body">
      <div class="field" style="margin-bottom:14px"><label>Email Address *</label><input type="email" id="inv-email" placeholder="colleague@company.com"></div>
      <div class="field" style="margin-bottom:4px"><label>Access Level</label>
        <div class="role-selector">
          <div class="role-option active" id="role-viewer" onclick="_selectRole('viewer')">
            <div class="role-icon">üëÅ</div>
            <div><div style="font-weight:600;font-size:13px">View Only</div><div style="font-size:11px;color:var(--muted);margin-top:2px">Can see all licenses, cannot edit</div></div>
            <span class="role-check active" id="role-check-viewer">‚úì</span>
          </div>
          <div class="role-option" id="role-editor" onclick="_selectRole('editor')">
            <div class="role-icon">‚úé</div>
            <div><div style="font-weight:600;font-size:13px">Full Access</div><div style="font-size:11px;color:var(--muted);margin-top:2px">Can add, edit, and delete licenses</div></div>
            <span class="role-check" id="role-check-editor">‚úì</span>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="_sendInvite()">Send Invitation</button>
      <button class="btn btn-ghost" onclick="_closeInviteModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="overlay" id="edit-modal">
  <div class="modal" style="max-width:520px">
    <div class="modal-header"><h3>Edit License</h3></div>
    <div class="modal-body">
      <div class="form-grid fg-2" style="margin-bottom:14px">
        <div class="field"><label>License Name *</label><input id="e-name" placeholder="e.g. Adobe Creative Cloud"></div>
        <div class="field"><label>Vendor</label><input id="e-vendor" placeholder="e.g. Adobe Inc."></div>
      </div>
      <div class="form-grid fg-3" style="margin-bottom:14px">
        <div class="field"><label>Expiration Date *</label><input type="date" id="e-expiry"></div>
        <div class="field"><label>Annual Cost</label><input id="e-cost" placeholder="e.g. $299 / year"></div>
        <div class="field"><label>Seats</label><input type="number" id="e-seats" placeholder="e.g. 10" min="1"></div>
      </div>
      <div class="form-grid" style="margin-bottom:14px">
        <div class="field"><label>Category</label><select id="e-cat"><option>Software</option><option>SaaS</option><option>Domain</option><option>SSL / Security</option><option>Hardware</option><option>Other</option></select></div>
      </div>
      <div class="field" style="margin-bottom:4px"><label>Internal Notes</label><input id="e-notes" placeholder="Seat count, account owner‚Ä¶"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="_confirmEdit()">Save Changes</button>
      <button class="btn btn-ghost" onclick="_closeEditModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- RENEW MODAL -->
<div class="overlay" id="renew-modal">
  <div class="modal">
    <div class="modal-header"><h3>Renew License</h3><p style="font-size:13px;color:var(--muted);font-weight:300;margin-top:6px" id="renew-modal-name"></p></div>
    <div class="modal-body">
      <div class="form-grid fg-2" style="margin-bottom:14px">
        <div class="field"><label>New Expiry Date *</label><input type="date" id="r-expiry"></div>
        <div class="field"><label>Updated Cost</label><input id="r-cost" placeholder="e.g. $299 / year"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" id="renew-confirm-btn" onclick="_confirmRenew()"><span class="renew-btn-text">‚úì Confirm Renewal</span></button>
      <button class="btn btn-ghost" onclick="_closeRenewModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- DELETE MODAL -->
<div class="overlay" id="del-modal">
  <div class="modal">
    <div class="modal-header"><h3>Remove License?</h3></div>
    <div class="modal-body"><p style="font-size:13px;color:var(--muted)">This entry will be permanently deleted from this vault. This cannot be undone.</p></div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="_confirmDelete()">Remove Entry</button>
      <button class="btn btn-ghost" onclick="_closeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- DELETE VAULT MODAL -->
<div class="overlay" id="del-vault-modal">
  <div class="modal">
    <div class="modal-header"><h3>Delete Vault?</h3></div>
    <div class="modal-body"><p style="font-size:13px;color:var(--muted)">This will permanently delete the vault and all its licenses. This cannot be undone.</p></div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="_confirmDeleteVault()">Delete Vault</button>
      <button class="btn btn-ghost" onclick="document.getElementById('del-vault-modal').classList.remove('open')">Cancel</button>
    </div>
  </div>
</div>

<!-- COMMENTS MODAL -->
<div class="overlay" id="comments-modal">
  <div class="modal" style="max-width:520px">
    <div class="modal-header">
      <h3>Comments</h3>
      <p style="font-size:13px;color:var(--muted);font-weight:300;margin-top:4px" id="comments-license-name"></p>
    </div>
    <div class="modal-body" style="padding-bottom:0">
      <div class="comment-thread" id="comment-thread"></div>
      <div class="comment-input-wrap">
        <textarea class="comment-input" id="comment-input" placeholder="Add a comment‚Ä¶ use @name to mention a member" rows="2" onkeydown="_commentKeydown(event)"></textarea>
        <button class="comment-submit" onclick="_submitComment()">Post</button>
      </div>
      <div class="mention-hint">Tip: type @name to notify a vault member</div>
    </div>
    <div class="modal-footer" style="padding-top:12px">
      <button class="btn btn-ghost" onclick="document.getElementById('comments-modal').classList.remove('open')">Close</button>
    </div>
  </div>
</div>

<!-- TRANSFER OWNERSHIP MODAL -->
<div class="overlay" id="transfer-modal">
  <div class="modal">
    <div class="modal-header">
      <h3>Transfer Ownership</h3>
      <p style="font-size:13px;color:var(--muted);font-weight:300;margin-top:6px">This cannot be undone. You will become an editor of this vault.</p>
    </div>
    <div class="modal-body">
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:14px 16px;font-size:13px;color:var(--muted);">
        Transfer ownership of <strong id="transfer-vault-name" style="color:var(--text)"></strong> to <strong id="transfer-to-name" style="color:var(--text)"></strong>?
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="_confirmTransfer()">Yes, Transfer Ownership</button>
      <button class="btn btn-ghost" onclick="document.getElementById('transfer-modal').classList.remove('open')">Cancel</button>
    </div>
  </div>
</div>

<!-- RENAME VAULT MODAL -->
<div class="overlay" id="rename-vault-modal">
  <div class="modal">
    <div class="modal-header"><h3>Rename Vault</h3></div>
    <div class="modal-body">
      <div class="field" style="margin-bottom:12px"><label>Vault Name *</label><input id="rv-name" placeholder="e.g. Work Licenses"></div>
      <div class="field" style="margin-bottom:4px"><label>Description</label><input id="rv-desc" placeholder="Optional description"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="_confirmRenameVault()">Save</button>
      <button class="btn btn-ghost" onclick="document.getElementById('rename-vault-modal').classList.remove('open')">Cancel</button>
    </div>
  </div>
</div>

<!-- ACCOUNT MODAL -->
<div class="overlay" id="account-modal">
  <div class="modal">
    <div class="modal-header">
      <h3>Account Details</h3>
      <p style="font-size:13px;color:var(--muted);font-weight:300;margin-top:6px">Your re-newly account information.</p>
    </div>
    <div class="modal-body">
      <div class="field" style="margin-bottom:14px">
        <label>Display Name</label>
        <input id="acc-name" placeholder="Your name">
      </div>
      <div class="field" style="margin-bottom:4px">
        <label>Email Address</label>
        <input id="acc-email" disabled style="opacity:.6;cursor:not-allowed;">
      </div>
      <p style="font-size:11px;color:var(--faint);margin-top:6px">Email address cannot be changed here.</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="_saveAccountDetails()">Save Changes</button>
      <button class="btn btn-ghost" onclick="document.getElementById('account-modal').classList.remove('open')">Cancel</button>
    </div>
  </div>
</div>

<!-- RESET PASSWORD MODAL -->
<div class="overlay" id="reset-modal">
  <div class="modal">
    <div class="modal-header">
      <h3>Reset Password</h3>
      <p style="font-size:13px;color:var(--muted);font-weight:300;margin-top:6px">We'll send a reset link to your email.</p>
    </div>
    <div class="modal-body">
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:14px 16px;font-size:13px;color:var(--muted);">
        A password reset email will be sent to <strong id="reset-email-display" style="color:var(--text)"></strong>.
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" id="reset-send-btn" onclick="_sendPasswordReset()">Send Reset Email</button>
      <button class="btn btn-ghost" onclick="document.getElementById('reset-modal').classList.remove('open')">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, doc, getDocs, setDoc, deleteDoc, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyBxSpcb3DMtv7UWStqrxA9xULASE7eE_kI",
  authDomain: "renewly-af1de.firebaseapp.com",
  projectId: "renewly-af1de",
  storageBucket: "renewly-af1de.firebasestorage.app",
  messagingSenderId: "730729566841",
  appId: "1:730729566841:web:7d45d0a548e4800b14faa8"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const auth = getAuth(app);
const googleProvider = new GoogleAuthProvider();

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentUser  = null;
let myVaults     = [];   // [{id, name, desc, ownerId, role:'owner'}]
let sharedVaults = [];   // [{id, name, ownerId, ownerName, ownerEmail, role:'viewer'|'editor'}]
let currentVault = null; // the active vault object
let licenses     = [];
let settings     = { email:'', intervals:[60,30,7] };
let members      = [];
let delTarget    = null;
let editTarget   = null;
let renewTarget  = null;
let selectedRole = 'viewer';
let activeFilter = 'all';
let searchQuery  = '';
let delVaultTarget = null;
let selectedIds = new Set();
let renameVaultTarget = null;

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function uid()     { return Date.now().toString(36)+Math.random().toString(36).slice(2); }
function diff(exp) { const n=new Date(); n.setHours(0,0,0,0); return Math.round((new Date(exp+'T00:00:00')-n)/86400000); }
function esc(s)    { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2800); }
function vaultCol(path) { return `vaults/${currentVault.id}/${path}`; }

// ‚îÄ‚îÄ Auth UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.switchTab = (tab) => {
  document.getElementById('tab-login').classList.toggle('active', tab==='login');
  document.getElementById('tab-signup').classList.toggle('active', tab==='signup');
  document.getElementById('auth-submit-btn').textContent = tab==='login' ? 'Sign In' : 'Create Account';
  document.getElementById('auth-error').classList.remove('show');
};

function showAuthError(msg) {
  const el = document.getElementById('auth-error');
  el.textContent = msg; el.classList.add('show');
}

window.submitAuth = async () => {
  const email = document.getElementById('auth-email').value.trim();
  const password = document.getElementById('auth-password').value;
  const isLogin = document.getElementById('tab-login').classList.contains('active');
  if (!email||!password) { showAuthError('Please enter your email and password.'); return; }
  try {
    if (isLogin) { await signInWithEmailAndPassword(auth,email,password); }
    else { await createUserWithEmailAndPassword(auth,email,password); }
  } catch(e) {
    const msgs = {'auth/invalid-email':'Invalid email address.','auth/user-not-found':'No account found.','auth/wrong-password':'Incorrect password.','auth/email-already-in-use':'Account already exists ‚Äî sign in instead.','auth/weak-password':'Password must be at least 6 characters.','auth/invalid-credential':'Invalid email or password.'};
    showAuthError(msgs[e.code]||e.message);
  }
};

window.signInWithGoogle = async () => {
  try { await signInWithPopup(auth, googleProvider); }
  catch(e) { showAuthError('Google sign-in failed. Please try again.'); }
};

window._signOut = () => signOut(auth);

function hideLoader() {
  const loader = document.getElementById('loading-screen');
  loader.classList.add('fade-out');
  setTimeout(() => loader.style.display='none', 300);
}

// ‚îÄ‚îÄ Auth State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    document.getElementById('auth-screen').classList.add('hidden');
    document.getElementById('app-screen').classList.remove('hidden');
    hideLoader();
    const displayName = user.displayName || user.email;
    const initials = (user.displayName || user.email || '?').slice(0,2).toUpperCase();
    document.getElementById('user-menu-name').textContent = user.displayName || user.email.split('@')[0];
    document.getElementById('user-avatar').textContent = initials;
    document.getElementById('dd-name').textContent = user.displayName || user.email.split('@')[0];
    document.getElementById('dd-email').textContent = user.email;
    const d = new Date();
    document.getElementById('nav-date').textContent = d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
    document.querySelectorAll('#form-chips .chip').forEach(c => { c.onclick = () => c.classList.toggle('on'); });

    // Ensure user doc exists
    try {
      const userDocRef = doc(db, 'users', user.uid);
      const userDocSnap = await getDoc(userDocRef);
      if (!userDocSnap.exists()) {
        await setDoc(userDocRef, { email: user.email, displayName: user.displayName||'', createdAt: new Date().toISOString() });
      }
    } catch(e) {}

    await loadDashboard();
    // Restore vault from URL hash if present (e.g. after page refresh)
    const hash = window.location.hash;
    const vaultMatch = hash.match(/^#vault\/(.+)$/);
    if (vaultMatch) {
      const savedId = vaultMatch[1];
      const found = [...myVaults, ...sharedVaults].find(v => v.id === savedId);
      if (found) openVault(found.id, found.role);
    } else if (hash === '#insights') {
      _openInsights();
    }
  } else {
    currentUser = null;
    document.getElementById('auth-screen').classList.remove('hidden');
    document.getElementById('app-screen').classList.add('hidden');
    hideLoader();
  }
});

// ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadDashboard() {
  myVaults = []; sharedVaults = [];

  // Load vaults I own
  const ownerSnap = await getDocs(collection(db, `users/${currentUser.uid}/vaults`));
  const vaultRefs = ownerSnap.docs.map(d => ({ id: d.id, ...d.data() }));

  for (const ref of vaultRefs) {
    try {
      const vDoc = await getDoc(doc(db, `vaults/${ref.id}`));
      if (vDoc.exists()) {
        const licSnap = await getDocs(collection(db, `vaults/${ref.id}/licenses`));
        const lics = licSnap.docs.map(d => ({ id:d.id, ...d.data() })).filter(l=>l.name);
        myVaults.push({ ...vDoc.data(), id: ref.id, role:'owner', licenses: lics });
      }
    } catch(e) {}
  }

  // Load shared vaults from user's own sharedVaults subcollection (written on invite accept)
  try {
    const sharedSnap = await getDocs(collection(db, `users/${currentUser.uid}/sharedVaults`));
    for (const refDoc of sharedSnap.docs) {
      const ref = refDoc.data();
      try {
        const vDoc = await getDoc(doc(db, `vaults/${ref.vaultId}`));
        if (!vDoc.exists()) continue;
        const licSnap = await getDocs(collection(db, `vaults/${ref.vaultId}/licenses`));
        const lics = licSnap.docs.map(d => ({id:d.id,...d.data()})).filter(l=>l.name);
        sharedVaults.push({
          ...vDoc.data(), id: ref.vaultId,
          ownerId: ref.ownerId,
          ownerName: ref.ownerName || ref.ownerEmail,
          ownerEmail: ref.ownerEmail,
          role: ref.role,
          licenses: lics
        });
      } catch(e) {}
    }
  } catch(e) {}

  renderDashboard();
}

function renderDashboard() {
  showScreen('dashboard');
  document.getElementById('nav-vault-label').style.display = 'none';
  const grid = document.getElementById('vault-grid');
  const allVaults = [...myVaults, ...sharedVaults];

  let html = '';

  // My vaults
  myVaults.forEach(v => {
    const expired = v.licenses.filter(l => diff(l.expiry) < 0).length;
    const expiring = v.licenses.filter(l => { const d=diff(l.expiry); return d>=0&&d<=30; }).length;
    const isArchived = v.archived;
    html += `<div class="vault-card${isArchived?' archived-card':''}" onclick="openVault('${v.id}','owner')">
      <span class="vault-role-badge ${isArchived?'badge-archived':'badge-owner'}">${isArchived?'Archived':'Owner'}</span>
      <div class="vault-card-icon">${isArchived?'üì¶':'üóÑÔ∏è'}</div>
      <div class="vault-card-name">${esc(v.name)}</div>
      <div class="vault-card-meta">${esc(v.desc||'Personal vault')}</div>
      <div class="vault-card-stats">
        <div class="vault-stat"><strong>${v.licenses.length}</strong>licenses</div>
        ${expired ? `<div class="vault-stat stat-danger"><strong>${expired}</strong>expired</div>` : ''}
        ${expiring ? `<div class="vault-stat stat-warn"><strong>${expiring}</strong>expiring</div>` : ''}
      </div>
      <div class="vault-card-actions" onclick="event.stopPropagation()">
        <button class="vault-action-btn" onclick="_openRenameVault('${v.id}')">‚úé Rename</button>
        <button class="vault-action-btn" onclick="_toggleArchiveVault('${v.id}',${!isArchived})">${isArchived?'‚Ü© Unarchive':'üì¶ Archive'}</button>
        <button class="vault-action-btn danger" onclick="_promptDeleteVault('${v.id}')">‚úï Delete</button>
      </div>
    </div>`;
  });

  // Shared vaults
  sharedVaults.forEach(v => {
    const expired = v.licenses.filter(l => diff(l.expiry) < 0).length;
    const expiring = v.licenses.filter(l => { const d=diff(l.expiry); return d>=0&&d<=30; }).length;
    const badgeClass = v.role === 'editor' ? 'badge-editor' : 'badge-viewer';
    const badgeLabel = v.role === 'editor' ? 'Editor' : 'Viewer';
    html += `<div class="vault-card shared-card" onclick="openVault('${v.id}','${v.role}')">
      <span class="vault-role-badge ${badgeClass}">${badgeLabel}</span>
      <div class="vault-card-icon">üîê</div>
      <div class="vault-card-name">${esc(v.name)}</div>
      <div class="vault-card-meta">Shared by ${esc(v.ownerName)}</div>
      <div class="vault-card-stats">
        <div class="vault-stat"><strong>${v.licenses.length}</strong>licenses</div>
        ${expired ? `<div class="vault-stat stat-danger"><strong>${expired}</strong>expired</div>` : ''}
        ${expiring ? `<div class="vault-stat stat-warn"><strong>${expiring}</strong>expiring</div>` : ''}
      </div>
    </div>`;
  });

  // New vault card
  html += `<div class="vault-card new-card" onclick="_openCreateVaultModal()">
    <div class="new-card-plus">+</div>
    <div class="new-card-label">Create New Vault</div>
  </div>`;

  grid.innerHTML = html;
}

// ‚îÄ‚îÄ Open Vault ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.openVault = async (vaultId, role) => {
  const vault = [...myVaults, ...sharedVaults].find(v => v.id === vaultId);
  if (!vault) return;
  currentVault = vault;
  licenses = [...vault.licenses];
  activeFilter = 'all'; searchQuery = ''; selectedIds.clear();

  showScreen('vault', vaultId);
  document.getElementById('nav-vault-label').style.display = 'flex';
  document.getElementById('nav-vault-name').textContent = vault.name;

  // Vault title
  document.getElementById('vault-title').innerHTML = esc(vault.name).replace(/(\S+)\s+(.+)/, '$1 <span>$2</span>') || `<span>${esc(vault.name)}</span>`;
  document.getElementById('vault-subtitle').textContent = role === 'owner'
    ? (vault.desc || 'Your personal vault')
    : `Shared by ${vault.ownerName} ¬∑ ${role === 'editor' ? 'Full Access' : 'View Only'}`;

  // Show/hide add button
  const canEdit = role === 'owner' || role === 'editor';
  document.getElementById('add-license-btn').style.display = canEdit ? 'flex' : 'none';
  document.getElementById('add-form').classList.remove('open');

  // Show/hide members panel (owner only)
  document.getElementById('vault-members-panel').style.display = role === 'owner' ? 'block' : 'none';
  document.getElementById('activity-panel').style.display = (role === 'owner' || role === 'editor') ? 'block' : 'none';
  if (role === 'owner' || role === 'editor') loadActivityLog();
  document.getElementById('reminder-panel').style.display = 'block';

  // Load settings for this vault
  settings = { email:'', intervals:[60,30,7] };
  try {
    const sSnap = await getDoc(doc(db, `vaults/${vaultId}/settings/global`));
    if (sSnap.exists()) {
      settings = sSnap.data();
      const intervals = settings.intervals || [60,30,7];
      [90,60,30,14,7,3,1].forEach(d => {
        const check = document.getElementById('rc-'+d);
        if (check) check.classList.toggle('active', intervals.includes(d));
      });
    }
  } catch(e) {}
  _updateReminderTriggerText();
  _initReminderDropdown();

  // Load members if owner
  if (role === 'owner') await loadMembers();
  await loadUserTemplates();

  // Render
  document.getElementById('search-input').value = '';
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter==='all'));
  render();
};

window.goToDashboard = async () => {
  currentVault = null; licenses = [];
  history.replaceState(null, '', window.location.pathname);
  document.getElementById('nav-vault-label').style.display = 'none';
  await loadDashboard();
};

function showScreen(name, vaultId) {
  document.getElementById('dashboard-screen').classList.toggle('show', name==='dashboard');
  document.getElementById('vault-screen').classList.toggle('show', name==='vault');
  document.getElementById('insights-screen').classList.toggle('show', name==='insights');
  document.getElementById('nav-insights-btn').classList.toggle('active', name==='insights');
  if (name === 'vault' && vaultId) {
    history.replaceState(null, '', `#vault/${vaultId}`);
  } else if (name === 'insights') {
    history.replaceState(null, '', '#insights');
  }
}

// ‚îÄ‚îÄ Create Vault ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window._openCreateVaultModal = () => {
  document.getElementById('cv-name').value = '';
  document.getElementById('cv-desc').value = '';
  document.getElementById('create-vault-modal').classList.add('open');
};
window._closeCreateVaultModal = () => document.getElementById('create-vault-modal').classList.remove('open');

window._confirmCreateVault = async () => {
  const name = document.getElementById('cv-name').value.trim();
  if (!name) { toast('Please enter a vault name.'); return; }

  const btn = document.querySelector('#create-vault-modal .btn-primary');
  btn.disabled = true; btn.textContent = 'Creating‚Ä¶';

  try {
    const vaultId = uid();
    const vaultData = {
      id: vaultId, name,
      desc: document.getElementById('cv-desc').value.trim(),
      ownerId: currentUser.uid,
      createdAt: new Date().toISOString()
    };
    await setDoc(doc(db, `vaults/${vaultId}`), vaultData);
    await setDoc(doc(db, `users/${currentUser.uid}/vaults/${vaultId}`), { name, createdAt: vaultData.createdAt });

    const newVault = { ...vaultData, role:'owner', licenses:[] };
    myVaults.push(newVault);

    window._closeCreateVaultModal();
    btn.disabled = false; btn.textContent = 'Create Vault';

    // Directly set currentVault and enter ‚Äî no array lookup needed
    currentVault = newVault;
    licenses = [];
    activeFilter = 'all'; searchQuery = ''; selectedIds.clear();
    settings = { email:'', intervals:[60,30,7] };

    showScreen('vault', vaultId);
    document.getElementById('nav-vault-label').style.display = 'flex';
    document.getElementById('nav-vault-name').textContent = name;
    document.getElementById('vault-title').innerHTML = `<span>${esc(name)}</span>`;
    document.getElementById('vault-subtitle').textContent = vaultData.desc || 'Your personal vault';
    document.getElementById('add-license-btn').style.display = 'flex';
    document.getElementById('add-form').classList.remove('open');
    document.getElementById('vault-members-panel').style.display = 'block';
    document.getElementById('reminder-panel').style.display = 'block';
    document.getElementById('activity-panel').style.display = 'block';
    document.getElementById('search-input').value = '';
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b.dataset.filter==='all'));
    _updateReminderTriggerText();
    _initReminderDropdown();
    members = []; renderMembers();
    render();
    toast(`Vault "${name}" created!`);
  } catch(e) {
    btn.disabled = false; btn.textContent = 'Create Vault';
    toast('Error creating vault: ' + e.message);
  }
};

// ‚îÄ‚îÄ Delete Vault ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window._promptDeleteVault = (vaultId) => {
  delVaultTarget = vaultId;
  document.getElementById('del-vault-modal').classList.add('open');
};
window._confirmDeleteVault = async () => {
  if (!delVaultTarget) return;
  toast('Deleting vault‚Ä¶');
  try {
    // Delete all licenses in vault
    const licSnap = await getDocs(collection(db, `vaults/${delVaultTarget}/licenses`));
    const batch = writeBatch(db);
    licSnap.docs.forEach(d => batch.delete(d.ref));
    batch.delete(doc(db, `vaults/${delVaultTarget}`));
    batch.delete(doc(db, `users/${currentUser.uid}/vaults/${delVaultTarget}`));
    await batch.commit();
    myVaults = myVaults.filter(v => v.id !== delVaultTarget);
    document.getElementById('del-vault-modal').classList.remove('open');
    delVaultTarget = null;
    toast('Vault deleted.');
    goToDashboard();
  } catch(e) { toast('Error: '+e.message); }
};

// ‚îÄ‚îÄ Licenses ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveLicense(lic) {
  await setDoc(doc(db, `vaults/${currentVault.id}/licenses/${lic.id}`), lic);
  // Also update cached licenses in vault
  const vi = [...myVaults,...sharedVaults].findIndex(v=>v.id===currentVault.id);
}

function statusOf(days) {
  if (days < 0)   return {row:'row-expired',  tag:'tag-expired',  label:'Expired',  dc:'c-danger', dtext:`${Math.abs(days)}d overdue`};
  if (days <= 7)  return {row:'row-critical', tag:'tag-critical', label:'Critical', dc:'c-danger', dtext:`${days}d left`};
  if (days <= 30) return {row:'row-warning',  tag:'tag-warning',  label:'Expiring', dc:'c-warn',   dtext:`${days}d left`};
  return              {row:'',             tag:'tag-ok',       label:'Active',   dc:'c-ok',     dtext:`${days}d left`};
}

function getFiltered() {
  return [...licenses]
    .filter(l => {
      const q = searchQuery.toLowerCase();
      if (q && !l.name.toLowerCase().includes(q) && !(l.vendor||'').toLowerCase().includes(q) && !(l.category||'').toLowerCase().includes(q)) return false;
      if (activeFilter==='expired')  return diff(l.expiry)<0;
      if (activeFilter==='expiring') return diff(l.expiry)>=0&&diff(l.expiry)<=30;
      if (activeFilter==='active')   return diff(l.expiry)>30;
      return true;
    })
    .sort((a,b)=>diff(a.expiry)-diff(b.expiry));
}

window._filterLicenses = () => { searchQuery = document.getElementById('search-input').value; render(); };
window._setFilter = (f, el) => {
  activeFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.toggle('active', b===el));
  render();
};

const canEditVault = () => currentVault && (currentVault.role === 'owner' || currentVault.role === 'editor');

function render() {
  const sorted = getFiltered();
  const list = document.getElementById('license-list');
  const canEdit = canEditVault();
  if (!sorted.length) {
    const msg = searchQuery||activeFilter!=='all' ? 'No licenses match your search or filter.' : 'No licenses in this vault yet.';
    list.innerHTML = `<div class="table-empty"><div style="font-size:28px;opacity:.2;margin-bottom:8px">üìã</div><p>${msg}</p></div>`;
  } else {
    list.innerHTML = sorted.map((lic,i) => {
      const days=diff(lic.expiry), s=statusOf(days);
      const seats = lic.seats ? `<span style="font-weight:500">${esc(String(lic.seats))}</span>` : '‚Äî';
      const isChecked = selectedIds.has(lic.id);
      return `<div class="table-row ${s.row}${isChecked?' row-selected':''}" style="animation-delay:${i*35}ms">
        <div><input type="checkbox" class="row-checkbox" ${isChecked?'checked':''} onchange="_toggleSelect('${lic.id}',this.checked)" onclick="event.stopPropagation()"></div>
        <div><div class="row-name">${esc(lic.name)}</div><div class="row-vendor">${esc(lic.vendor||'‚Äî')}${lic.notes?` ¬∑ <span style="color:var(--faint)">${esc(lic.notes)}</span>`:''}</div></div>
        <div class="row-cell">${esc(lic.category||'‚Äî')}</div>
        <div class="row-cell">${lic.expiry}</div>
        <div class="row-cost">${esc(lic.cost||'‚Äî')}</div>
        <div class="row-cell">${seats}</div>
        <div class="status-cell"><span class="status-tag ${s.tag}"><span class="tag-dot"></span>${s.label}</span><span class="days-count ${s.dc}">${s.dtext}</span></div>
        <div class="row-actions">
          <button class="btn-icon btn-comment" onclick="window._openComments('${lic.id}')">
            <svg viewBox="0 0 14 14" fill="none" width="12" height="12"><path d="M7 1.5C3.96 1.5 1.5 3.52 1.5 6c0 .9.3 1.75.82 2.46L1.5 11l2.8-1.1A6.1 6.1 0 0 0 7 10.5c3.04 0 5.5-2.02 5.5-4.5S10.04 1.5 7 1.5z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round"/></svg>
            ${(lic.commentCount&&lic.commentCount>0) ? `<span style="background:var(--accent);color:#faf6ef;border-radius:20px;padding:0 5px;font-size:9px;min-width:14px;text-align:center;">${lic.commentCount}</span>` : ''}
          </button>
          ${canEdit ? `<button class="btn-renew" onclick="window._promptRenew('${lic.id}')">‚Üª Renew</button>` : ''}
          ${canEdit ? `<button class="btn-icon btn-edit" onclick="window._promptEdit('${lic.id}')"><svg viewBox="0 0 14 14" fill="none" width="11" height="11"><path d="M9.5 2.5l2 2L4 12H2v-2L9.5 2.5z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round"/></svg> Edit</button>` : ''}
          ${canEdit ? `<button class="btn-icon btn-delete" onclick="window._promptDelete('${lic.id}')"><svg viewBox="0 0 14 14" fill="none" width="11" height="11"><path d="M2 3.5h10M5.5 3.5V2.5h3v1M5 5.5v5M9 5.5v5M3.5 3.5l.5 8h6l.5-8" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg> Delete</button>` : '<span style="font-size:11px;color:var(--faint);padding:0 8px;">View only</span>'}
        </div>
      </div>`;
    }).join('');
  }
  const total = licenses.length;
  document.getElementById('row-count').textContent = sorted.length!==total ? `${sorted.length} of ${total}` : total ? `${total} entr${total===1?'y':'ies'}` : '';
  document.getElementById('k-total').textContent   = total;
  document.getElementById('k-expired').textContent = licenses.filter(l=>diff(l.expiry)<0).length;
  document.getElementById('k-warn').textContent    = licenses.filter(l=>{const d=diff(l.expiry);return d>=0&&d<=30;}).length;
  document.getElementById('k-ok').textContent      = licenses.filter(l=>diff(l.expiry)>30).length;
}

// ‚îÄ‚îÄ CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window._toggleForm = () => { if(canEditVault()) { document.getElementById('add-form').classList.toggle('open'); if(document.getElementById('add-form').classList.contains('open')) { _renderTemplates(); document.getElementById('dup-warning').classList.remove('show'); } } };

window._addLicense = async () => {
  const name=document.getElementById('f-name').value.trim(), expiry=document.getElementById('f-expiry').value;
  if (!name||!expiry) { toast('License name and expiry date are required.'); return; }
  const seatsVal=document.getElementById('f-seats').value.trim();
  const lic = {
    id:uid(), name,
    vendor:   document.getElementById('f-vendor').value.trim(),
    category: document.getElementById('f-cat').value,
    expiry, cost: document.getElementById('f-cost').value.trim(),
    seats:    seatsVal ? parseInt(seatsVal) : null,
    notes:    document.getElementById('f-notes').value.trim(),
    reminders:[...document.querySelectorAll('#form-chips .chip.on')].map(c=>+c.dataset.d)
  };
  toast('Saving‚Ä¶'); await saveLicense(lic);
  await logActivity('add', `Added license <strong>${esc(lic.name)}</strong>`, lic.id);
  licenses.push(lic); render();
  ['f-name','f-vendor','f-expiry','f-cost','f-notes','f-seats'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('add-form').classList.remove('open');
  toast('License saved.');
};

window._promptDelete = (id) => { delTarget=id; document.getElementById('del-modal').classList.add('open'); };
window._closeModal   = ()   => { document.getElementById('del-modal').classList.remove('open'); delTarget=null; };

window._confirmDelete = async () => {
  try {
    toast('Deleting‚Ä¶');
    const delLic = licenses.find(l=>l.id===delTarget);
    await deleteDoc(doc(db, `vaults/${currentVault.id}/licenses/${delTarget}`));
    await logActivity('delete', `Removed license <strong>${esc(delLic?.name||'')}</strong>`);
    licenses = licenses.filter(l=>l.id!==delTarget);
    render(); window._closeModal(); toast('Entry removed.');
  } catch(e) { toast('Error: '+e.message); }
};

// Edit
window._promptEdit = (id) => {
  const lic = licenses.find(l=>l.id===id); if(!lic) return;
  editTarget=id;
  document.getElementById('e-name').value   = lic.name||'';
  document.getElementById('e-vendor').value = lic.vendor||'';
  document.getElementById('e-expiry').value = lic.expiry||'';
  document.getElementById('e-cost').value   = lic.cost||'';
  document.getElementById('e-seats').value  = lic.seats||'';
  document.getElementById('e-notes').value  = lic.notes||'';
  const catSel=document.getElementById('e-cat');
  [...catSel.options].forEach((o,i)=>{ if(o.value===lic.category) catSel.selectedIndex=i; });
  document.getElementById('edit-modal').classList.add('open');
};
window._closeEditModal = () => { document.getElementById('edit-modal').classList.remove('open'); editTarget=null; };
window._confirmEdit = async () => {
  if(!editTarget) return;
  const name=document.getElementById('e-name').value.trim(), expiry=document.getElementById('e-expiry').value;
  if(!name||!expiry) { toast('Name and expiry are required.'); return; }
  const idx=licenses.findIndex(l=>l.id===editTarget); if(idx===-1) return;
  const eSeats=document.getElementById('e-seats').value.trim();
  licenses[idx]={...licenses[idx],name,vendor:document.getElementById('e-vendor').value.trim(),expiry,cost:document.getElementById('e-cost').value.trim(),seats:eSeats?parseInt(eSeats):null,notes:document.getElementById('e-notes').value.trim(),category:document.getElementById('e-cat').value};
  toast('Saving‚Ä¶'); await saveLicense(licenses[idx]); await logActivity('edit', `Updated license <strong>${esc(licenses[idx].name)}</strong>`, licenses[idx].id); render(); window._closeEditModal(); toast('License updated.');
};

// Renew
window._promptRenew = (id) => {
  const lic=licenses.find(l=>l.id===id); if(!lic) return;
  renewTarget=id;
  document.getElementById('renew-modal-name').textContent=lic.name;
  document.getElementById('r-expiry').value='';
  document.getElementById('r-cost').value=lic.cost||'';
  const btn=document.getElementById('renew-confirm-btn');
  btn.classList.remove('renewed'); btn.querySelector('.renew-btn-text').textContent='‚úì Confirm Renewal';
  btn.onclick=window._confirmRenew;
  document.getElementById('renew-modal').classList.add('open');
};
window._closeRenewModal = () => { document.getElementById('renew-modal').classList.remove('open'); renewTarget=null; };
window._confirmRenew = async () => {
  if(!renewTarget) return;
  const expiry=document.getElementById('r-expiry').value;
  if(!expiry) { toast('Please enter the new expiry date.'); return; }
  const idx=licenses.findIndex(l=>l.id===renewTarget); if(idx===-1) return;
  licenses[idx]={...licenses[idx],expiry,cost:document.getElementById('r-cost').value.trim()||licenses[idx].cost};
  const btn=document.getElementById('renew-confirm-btn');
  btn.classList.add('renewed'); btn.querySelector('.renew-btn-text').textContent='‚úì Renewed!';
  toast('Saving‚Ä¶'); await saveLicense(licenses[idx]); await logActivity('renew', `Renewed <strong>${esc(licenses[idx].name)}</strong> ‚Üí ${expiry}`, licenses[idx].id); render();
  setTimeout(()=>window._closeRenewModal(),900); toast('License renewed!');
};

// ‚îÄ‚îÄ Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveGlobalIntervals() {
  settings.intervals = getSelectedIntervals();
  await setDoc(doc(db, `vaults/${currentVault.id}/settings/global`), settings);
  _updateReminderTriggerText();
}

function getSelectedIntervals() {
  return [90,60,30,14,7,3,1].filter(d=>{ const el=document.getElementById('rc-'+d); return el&&el.classList.contains('active'); });
}

function _updateReminderTriggerText() {
  const selected=getSelectedIntervals();
  const el=document.getElementById('reminder-trigger-text'); if(!el) return;
  el.textContent = selected.length===0 ? 'No reminders set' : selected.map(d=>d===1?'1 day':d+' days').join(', ')+' before expiry';
}

window._initReminderDropdown = function() {
  const intervals=settings.intervals||[60,30,7];
  [90,60,30,14,7,3,1].forEach(d=>{ const c=document.getElementById('rc-'+d); if(c) c.classList.toggle('active',intervals.includes(d)); });
  document.querySelectorAll('.reminder-option').forEach(opt=>{
    opt.onclick=async()=>{ const d=+opt.dataset.d; const c=document.getElementById('rc-'+d); if(!c) return; c.classList.toggle('active'); await saveGlobalIntervals(); };
  });
  _updateReminderTriggerText();
  document.addEventListener('click', e=>{
    const wrap=document.getElementById('reminder-dropdown-wrap');
    if(wrap&&!wrap.contains(e.target)){ document.getElementById('reminder-dropdown-menu')?.classList.remove('open'); document.getElementById('reminder-dropdown-trigger')?.classList.remove('open'); }
  });
};

window._toggleReminderDropdown = function() {
  document.getElementById('reminder-dropdown-menu').classList.toggle('open');
  document.getElementById('reminder-dropdown-trigger').classList.toggle('open');
};

// ‚îÄ‚îÄ Members ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadMembers() {
  try {
    const snap = await getDocs(collection(db, `vaults/${currentVault.id}/members`));
    members = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderMembers();
  } catch(e) {}
}

function renderMembers() {
  _updateTransferDropdown();
  const el=document.getElementById('members-list');
  if (!members.length) { el.innerHTML='<div class="members-empty">No members yet. Invite someone to share this vault.</div>'; return; }
  el.innerHTML=members.map(m=>{
    const initials=(m.email||'?').slice(0,2).toUpperCase();
    const badgeClass=m.status==='pending'?'badge-pending':m.role==='editor'?'badge-editor-m':'badge-viewer';
    const badgeLabel=m.status==='pending'?'Pending':m.role==='editor'?'Editor':'Viewer';
    return `<div class="member-row">
      <div class="member-avatar">${initials}</div>
      <div class="member-info"><div class="member-email">${esc(m.email)}</div><div class="member-meta">Invited ${m.invitedAt?new Date(m.invitedAt).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):''}</div></div>
      <span class="member-badge ${badgeClass}">${badgeLabel}</span>
      <button class="member-remove" onclick="window._removeMember('${m.id}')">Revoke</button>
    </div>`;
  }).join('');
}

window._openInviteModal = () => {
  document.getElementById('inv-email').value='';
  _selectRole('viewer');
  document.getElementById('invite-modal').classList.add('open');
};
window._closeInviteModal = () => document.getElementById('invite-modal').classList.remove('open');

window._selectRole = (role) => {
  selectedRole=role;
  ['viewer','editor'].forEach(r=>{ document.getElementById('role-'+r).classList.toggle('active',r===role); document.getElementById('role-check-'+r).classList.toggle('active',r===role); });
};

window._sendInvite = async () => {
  const email=document.getElementById('inv-email').value.trim().toLowerCase();
  if (!email||!email.includes('@')) { toast('Please enter a valid email address.'); return; }
  if (email===currentUser.email) { toast("You can't invite yourself."); return; }
  if (members.find(m=>m.email===email)) { toast('This person is already a member.'); return; }
  toast('Sending invitation‚Ä¶');
  try {
    const token=uid()+uid();
    const memberId=uid();
    const memberData={ email, role:selectedRole, status:'pending', invitedAt:new Date().toISOString(), token, memberId };
    await setDoc(doc(db,`vaults/${currentVault.id}/members/${memberId}`), memberData);
    await setDoc(doc(db,`invites/${token}`),{
      vaultId:currentVault.id, vaultName:currentVault.name,
      ownerId:currentUser.uid, ownerEmail:currentUser.email,
      ownerName:currentUser.displayName||currentUser.email,
      memberId, email, role:selectedRole, createdAt:new Date().toISOString()
    });
    await sendInviteEmail(email, currentUser.displayName||currentUser.email, currentVault.name, selectedRole, `https://re-newly.com/accept-invite.html?token=${token}`);
    members.push({id:memberId,...memberData});
    renderMembers();
    window._closeInviteModal();
    await logActivity('invite', `Invited <strong>${esc(email)}</strong> as ${selectedRole}`);
    toast('Invitation sent to '+email);
  } catch(e) { toast('Error: '+e.message); }
};

async function sendInviteEmail(toEmail, fromName, vaultName, role, acceptUrl) {
  const roleLabel=role==='editor'?'full access (view & edit)':'view-only access';
  const html=`<!DOCTYPE html><html><head><meta charset="UTF-8"></head>
<body style="margin:0;padding:0;background:#f2ece0;font-family:'Helvetica Neue',Arial,sans-serif">
<table width="100%" cellpadding="0" cellspacing="0" style="padding:40px 20px;background:#f2ece0"><tr><td align="center">
<table width="560" cellpadding="0" cellspacing="0" style="max-width:560px;width:100%">
  <tr><td style="background:#faf6ef;border:1px solid #ddd5c4;border-radius:10px 10px 0 0;padding:28px 40px;text-align:center;border-bottom:none">
    <div><span style="font-size:26px;font-family:Georgia,serif;font-style:italic;color:#6b5335">re-</span><span style="font-size:26px;font-family:Georgia,serif;color:#1e1a14">newly</span></div>
    <div style="font-size:10px;letter-spacing:4px;text-transform:uppercase;color:#b8ad9e;margin-top:4px">LICENSE TRACKER</div>
  </td></tr>
  <tr><td style="background:#faf6ef;border-left:1px solid #ddd5c4;border-right:1px solid #ddd5c4;padding:32px 40px">
    <h2 style="margin:0 0 12px;font-family:Georgia,serif;font-size:22px;font-weight:400;color:#1e1a14">You've been invited</h2>
    <p style="font-size:13px;color:#8a7f72;font-weight:300;margin:0 0 20px;line-height:1.7"><strong style="color:#1e1a14">${fromName}</strong> has invited you to access the <strong style="color:#1e1a14">"${vaultName}"</strong> vault with <strong style="color:#1e1a14">${roleLabel}</strong>.</p>
    <div style="text-align:center;margin-bottom:20px"><a href="${acceptUrl}" style="display:inline-block;padding:14px 32px;background:#6b5335;color:#faf6ef;text-decoration:none;border-radius:7px;font-size:13px;font-weight:600">Accept Invitation ‚Üí</a></div>
    <p style="font-size:11px;color:#b8ad9e;text-align:center;margin:0">If you don't have an account, you'll be asked to create one.</p>
  </td></tr>
  <tr><td style="background:#f5f0e6;border:1px solid #ddd5c4;border-top:none;border-radius:0 0 10px 10px;padding:20px 40px;text-align:center">
    <p style="margin:0;font-size:11px;color:#b8ad9e">¬© 2026 Karam Al-Ramahi ¬∑ <a href="https://re-newly.com" style="color:#6b5335;text-decoration:none">re-newly.com</a></p>
  </td></tr>
</table></td></tr></table></body></html>`;
  const res=await fetch('https://renewly-reminders.karumgg1.workers.dev/send-invite',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to:toEmail,fromName,html})});
  if (!res.ok) throw new Error('Could not send email');
}

window._removeMember = async (memberId) => {
  if (!confirm("Revoke this member's access?")) return;
  try {
    // Delete from vault members
    await deleteDoc(doc(db,`vaults/${currentVault.id}/members/${memberId}`));

    // For active members, the doc id IS their uid ‚Äî clean up their sharedVaults ref too
    const member = members.find(m => m.id === memberId);
    if (member && member.status === 'active') {
      try {
        await deleteDoc(doc(db,`users/${memberId}/sharedVaults/${currentVault.id}`));
      } catch(e) {} // best effort ‚Äî rules may not allow owner to delete from user's space
    }

    members = members.filter(m => m.id !== memberId);
    renderMembers();
    await logActivity('revoke', `Revoked access for <strong>${esc(member?.email||memberId)}</strong>`);
    toast('Access revoked.');
  } catch(e) { toast('Error revoking access: ' + e.message); }
};

// ‚îÄ‚îÄ User Menu ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window._toggleUserMenu = () => {
  document.getElementById('user-dropdown').classList.toggle('open');
  document.getElementById('user-menu-btn').classList.toggle('open');
};

// Close on outside click
document.addEventListener('click', e => {
  const wrap = document.getElementById('user-menu-wrap');
  if (wrap && !wrap.contains(e.target)) {
    document.getElementById('user-dropdown')?.classList.remove('open');
    document.getElementById('user-menu-btn')?.classList.remove('open');
  }
});

// ‚îÄ‚îÄ Account Details ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window._openAccountModal = () => {
  document.getElementById('user-dropdown').classList.remove('open');
  document.getElementById('user-menu-btn').classList.remove('open');
  document.getElementById('acc-name').value  = currentUser.displayName || '';
  document.getElementById('acc-email').value = currentUser.email || '';
  document.getElementById('account-modal').classList.add('open');
};

window._saveAccountDetails = async () => {
  const name = document.getElementById('acc-name').value.trim();
  try {
    const { updateProfile } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js");
    await updateProfile(currentUser, { displayName: name });
    // Update user doc in Firestore
    await setDoc(doc(db, `users/${currentUser.uid}`), {
      email: currentUser.email,
      displayName: name,
      createdAt: currentUser.metadata?.creationTime || new Date().toISOString()
    }, { merge: true });
    // Update navbar
    document.getElementById('user-menu-name').textContent = name || currentUser.email.split('@')[0];
    document.getElementById('user-avatar').textContent    = (name || currentUser.email).slice(0,2).toUpperCase();
    document.getElementById('dd-name').textContent        = name || currentUser.email.split('@')[0];
    document.getElementById('account-modal').classList.remove('open');
    toast('Account updated.');
  } catch(e) { toast('Error: ' + e.message); }
};

// ‚îÄ‚îÄ Reset Password ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window._openResetPasswordModal = () => {
  document.getElementById('user-dropdown').classList.remove('open');
  document.getElementById('user-menu-btn').classList.remove('open');
  document.getElementById('reset-email-display').textContent = currentUser.email;
  const btn = document.getElementById('reset-send-btn');
  btn.disabled = false; btn.textContent = 'Send Reset Email';
  document.getElementById('reset-modal').classList.add('open');
};

window._sendPasswordReset = async () => {
  const btn = document.getElementById('reset-send-btn');
  btn.disabled = true; btn.textContent = 'Sending‚Ä¶';
  try {
    const { sendPasswordResetEmail } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js");
    await sendPasswordResetEmail(auth, currentUser.email);
    btn.textContent = '‚úì Email Sent!';
    setTimeout(() => document.getElementById('reset-modal').classList.remove('open'), 1800);
    toast('Password reset email sent.');
  } catch(e) {
    btn.disabled = false; btn.textContent = 'Send Reset Email';
    toast('Error: ' + e.message);
  }
};




// ‚îÄ‚îÄ Activity Log ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ACTIVITY_ICONS = { add:'‚ûï', edit:'‚úé', renew:'‚Üª', delete:'‚úï', comment:'üí¨', transfer:'üîÅ', invite:'üì®', revoke:'üö´' };

async function logActivity(type, text, licenseId) {
  if (!currentVault || !currentUser) return;
  try {
    const entry = {
      type, text,
      licenseId: licenseId || null,
      userId: currentUser.uid,
      userName: currentUser.displayName || currentUser.email,
      createdAt: new Date().toISOString()
    };
    await setDoc(doc(db, `vaults/${currentVault.id}/activity/${uid()}`), entry);
    // Refresh log if panel visible
    if (document.getElementById('activity-panel')?.style.display !== 'none') {
      loadActivityLog();
    }
  } catch(e) {}
}

async function loadActivityLog() {
  const el = document.getElementById('activity-list');
  if (!el) return;
  try {
    const snap = await getDocs(collection(db, `vaults/${currentVault.id}/activity`));
    const items = snap.docs.map(d => d.data()).sort((a,b) => b.createdAt.localeCompare(a.createdAt)).slice(0,50);
    if (!items.length) { el.innerHTML = '<div class="activity-empty">No activity yet.</div>'; return; }
    el.innerHTML = items.map(item => {
      const icon = ACTIVITY_ICONS[item.type] || '‚Ä¢';
      const time = item.createdAt ? _relTime(item.createdAt) : '';
      return `<div class="activity-item">
        <div class="activity-icon">${icon}</div>
        <div class="activity-body">
          <div class="activity-text">${item.text}</div>
          <div class="activity-meta">${esc(item.userName)} ¬∑ ${time}</div>
        </div>
      </div>`;
    }).join('');
  } catch(e) { el.innerHTML = '<div class="activity-empty">Could not load activity.</div>'; }
}

function _relTime(iso) {
  const diff = Date.now() - new Date(iso).getTime();
  const mins = Math.floor(diff/60000);
  if (mins < 1)  return 'just now';
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins/60);
  if (hrs < 24)  return `${hrs}h ago`;
  const days = Math.floor(hrs/24);
  if (days < 7)  return `${days}d ago`;
  return new Date(iso).toLocaleDateString('en-US',{month:'short',day:'numeric'});
}

// ‚îÄ‚îÄ Comments ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let commentLicenseId = null;
let vaultMembers = []; // cached for @mention lookups

window._openComments = async (licId) => {
  commentLicenseId = licId;
  const lic = licenses.find(l => l.id === licId);
  document.getElementById('comments-license-name').textContent = lic ? lic.name : '';
  document.getElementById('comment-input').value = '';
  document.getElementById('comments-modal').classList.add('open');
  await _loadComments(licId);
};

async function _loadComments(licId) {
  const thread = document.getElementById('comment-thread');
  thread.innerHTML = '<div style="font-size:12px;color:var(--faint);padding:12px 0">Loading‚Ä¶</div>';
  try {
    const snap = await getDocs(collection(db, `vaults/${currentVault.id}/licenses/${licId}/comments`));
    const items = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => a.createdAt.localeCompare(b.createdAt));
    if (!items.length) { thread.innerHTML = '<div class="activity-empty">No comments yet. Be the first!</div>'; return; }
    thread.innerHTML = items.map(c => {
      const initials = (c.userName||'?').slice(0,2).toUpperCase();
      const canDel = c.userId === currentUser.uid || currentVault.role === 'owner';
      const text = _renderMentions(esc(c.text));
      return `<div class="comment-item" id="comment-${c.id}">
        <div class="comment-avatar">${initials}</div>
        <div class="comment-body">
          <div class="comment-header">
            <span class="comment-author">${esc(c.userName)}</span>
            <span class="comment-time">${_relTime(c.createdAt)}</span>
            ${canDel ? `<button class="comment-delete" onclick="_deleteComment('${licId}','${c.id}')">‚úï</button>` : ''}
          </div>
          <div class="comment-text">${text}</div>
        </div>
      </div>`;
    }).join('');
    // Update comment count on license
    const lic = licenses.find(l => l.id === licId);
    if (lic) lic.commentCount = items.length;
  } catch(e) { thread.innerHTML = '<div class="activity-empty">Could not load comments.</div>'; }
}

function _renderMentions(text) {
  return text.replace(/@([\w.-]+)/g, '<span class="mention">@$1</span>');
}

window._submitComment = async () => {
  const input = document.getElementById('comment-input');
  const text = input.value.trim();
  if (!text || !commentLicenseId) return;

  const btn = document.querySelector('#comments-modal .comment-submit');
  btn.disabled = true;

  try {
    const commentId = uid();
    const comment = {
      text,
      userId: currentUser.uid,
      userName: currentUser.displayName || currentUser.email,
      createdAt: new Date().toISOString()
    };
    await setDoc(doc(db, `vaults/${currentVault.id}/licenses/${commentLicenseId}/comments/${commentId}`), comment);

    // Log to activity
    const lic = licenses.find(l => l.id === commentLicenseId);
    await logActivity('comment', `Commented on <strong>${esc(lic?.name||'')}</strong>: "${text.slice(0,60)}${text.length>60?'‚Ä¶':''}"`, commentLicenseId);

    input.value = '';
    await _loadComments(commentLicenseId);
    render(); // update comment badge count
  } catch(e) { toast('Error posting comment: ' + e.message); }
  btn.disabled = false;
};

window._deleteComment = async (licId, commentId) => {
  try {
    await deleteDoc(doc(db, `vaults/${currentVault.id}/licenses/${licId}/comments/${commentId}`));
    const lic = licenses.find(l => l.id === licId);
    if (lic && lic.commentCount > 0) lic.commentCount--;
    await _loadComments(licId);
    render();
  } catch(e) { toast('Error: ' + e.message); }
};

window._commentKeydown = (e) => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); _submitComment(); }
};

// ‚îÄ‚îÄ Transfer Ownership ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let transferTarget = null;

window._promptTransfer = () => {
  const sel = document.getElementById('transfer-select');
  const memberId = sel.value;
  const memberEmail = sel.options[sel.selectedIndex]?.text;
  if (!memberId) { toast('Select a member to transfer to.'); return; }
  transferTarget = { memberId, memberEmail };
  document.getElementById('transfer-vault-name').textContent = currentVault.name;
  document.getElementById('transfer-to-name').textContent = memberEmail;
  document.getElementById('transfer-modal').classList.add('open');
};

window._confirmTransfer = async () => {
  if (!transferTarget) return;
  const { memberId, memberEmail } = transferTarget;
  try {
    // Update vault owner
    await setDoc(doc(db, `vaults/${currentVault.id}`), { ownerId: memberId }, { merge: true });

    // Move vault ref from old owner to new owner in /users
    await setDoc(doc(db, `users/${memberId}/vaults/${currentVault.id}`), {
      name: currentVault.name, createdAt: currentVault.createdAt || new Date().toISOString()
    });
    await deleteDoc(doc(db, `users/${currentUser.uid}/vaults/${currentVault.id}`));

    // Demote old owner to editor in members
    await setDoc(doc(db, `vaults/${currentVault.id}/members/${currentUser.uid}`), {
      email: currentUser.email,
      role: 'editor',
      status: 'active',
      acceptedAt: new Date().toISOString()
    });

    // Remove new owner from members (they are now the owner)
    await deleteDoc(doc(db, `vaults/${currentVault.id}/members/${memberId}`));
    // Also remove their sharedVaults ref
    try { await deleteDoc(doc(db, `users/${memberId}/sharedVaults/${currentVault.id}`)); } catch(e) {}

    await logActivity('transfer', `Transferred ownership to <strong>${esc(memberEmail)}</strong>`);

    document.getElementById('transfer-modal').classList.remove('open');
    transferTarget = null;
    toast('Ownership transferred. You are now an editor.');

    // Reload dashboard since this vault's ownership changed
    await goToDashboard();
  } catch(e) { toast('Error: ' + e.message); }
};

// Populate transfer dropdown when members load
function _updateTransferDropdown() {
  const sel = document.getElementById('transfer-select');
  if (!sel) return;
  const active = members.filter(m => m.status === 'active');
  if (!active.length) {
    document.getElementById('transfer-section').style.display = 'none';
    return;
  }
  document.getElementById('transfer-section').style.display = 'block';
  sel.innerHTML = '<option value="">Select a member‚Ä¶</option>' +
    active.map(m => `<option value="${m.id}">${esc(m.email)}</option>`).join('');
}

// ‚îÄ‚îÄ Insights ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let insightsVaultFilter = 'all'; // 'all' or vaultId
let calYear = new Date().getFullYear();
let calMonth = new Date().getMonth(); // 0-indexed

window._openInsights = () => {
  document.getElementById('nav-vault-label').style.display = 'none';
  showScreen('insights');
  _renderInsights();
};

function _getAllInsightsLicenses() {
  // Gather licenses from all vaults (own + shared), filtered by selection
  const allVaults = [...myVaults, ...sharedVaults];
  const filtered = insightsVaultFilter === 'all'
    ? allVaults
    : allVaults.filter(v => v.id === insightsVaultFilter);
  return filtered.flatMap(v => (v.licenses||[]).map(l => ({ ...l, _vaultName: v.name, _role: v.role })));
}

function _parseCost(costStr) {
  if (!costStr) return 0;
  // Extract numeric value ‚Äî handles "$299/year", "‚Ç¨12/mo", "15.99", etc.
  const match = String(costStr).replace(/,/g,'').match(/[\d.]+/);
  if (!match) return 0;
  let val = parseFloat(match[0]);
  const lower = costStr.toLowerCase();
  // Normalize to annual
  if (lower.includes('/mo') || lower.includes('month') || lower.includes('per month')) val *= 12;
  if (lower.includes('/wk') || lower.includes('week')) val *= 52;
  return val;
}

function _renderInsights() {
  const allVaults = [...myVaults, ...sharedVaults];

  // Vault selector
  const sel = document.getElementById('insights-vault-selector');
  sel.innerHTML = [
    `<button class="insights-vault-btn ${insightsVaultFilter==='all'?'active':''}" onclick="_insightsSetVault('all')">All Vaults</button>`,
    ...allVaults.map(v => `<button class="insights-vault-btn ${insightsVaultFilter===v.id?'active':''}" onclick="_insightsSetVault('${v.id}')">${esc(v.name)}</button>`)
  ].join('');

  const licenses = _getAllInsightsLicenses();

  // ‚îÄ‚îÄ Spend KPIs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const costsAnnual = licenses.map(l => _parseCost(l.cost)).filter(c => c > 0);
  const totalAnnual = costsAnnual.reduce((a,b) => a+b, 0);
  const thisMonth = licenses.filter(l => { const d = diff(l.expiry); return d >= 0 && d <= 30; }).length;

  document.getElementById('ins-annual').textContent   = totalAnnual > 0 ? `$${totalAnnual.toLocaleString('en-US',{maximumFractionDigits:0})}` : '‚Äî';
  document.getElementById('ins-monthly').textContent  = totalAnnual > 0 ? `$${(totalAnnual/12).toLocaleString('en-US',{maximumFractionDigits:0})}` : '‚Äî';
  document.getElementById('ins-count').textContent    = costsAnnual.length;
  document.getElementById('ins-thismonth').textContent = thisMonth;

  // ‚îÄ‚îÄ Category breakdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const byCat = {};
  licenses.forEach(l => {
    const cat = l.category || 'Other';
    const cost = _parseCost(l.cost);
    if (!byCat[cat]) byCat[cat] = { cost: 0, count: 0 };
    byCat[cat].cost += cost;
    byCat[cat].count++;
  });
  const catEntries = Object.entries(byCat).sort((a,b) => b[1].cost - a[1].cost);
  const maxCost = catEntries[0]?.[1]?.cost || 1;

  const catEl = document.getElementById('cat-breakdown');
  if (!catEntries.length) {
    catEl.innerHTML = '<div style="font-size:13px;color:var(--faint);font-style:italic;text-align:center;padding:20px 0">No licenses yet.</div>';
  } else {
    catEl.innerHTML = catEntries.map(([cat, {cost, count}]) => `
      <div class="cat-bar-row">
        <div class="cat-bar-label" title="${esc(cat)}">${esc(cat)}</div>
        <div class="cat-bar-track"><div class="cat-bar-fill" style="width:${Math.round((cost/maxCost)*100)}%"></div></div>
        <div class="cat-bar-val">${cost > 0 ? '$'+cost.toLocaleString('en-US',{maximumFractionDigits:0}) : count+' lic.'}</div>
      </div>`).join('');
  }

  // ‚îÄ‚îÄ Upcoming renewals list ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const upcoming = licenses
    .map(l => ({ ...l, days: diff(l.expiry) }))
    .filter(l => l.days <= 90)
    .sort((a,b) => a.days - b.days)
    .slice(0, 20);

  const upEl = document.getElementById('upcoming-list');
  if (!upcoming.length) {
    upEl.innerHTML = '<div style="font-size:13px;color:var(--faint);font-style:italic;padding:20px 0;text-align:center">No renewals in the next 90 days.</div>';
  } else {
    upEl.innerHTML = upcoming.map(l => {
      const dotClass = l.days < 0 ? 'background:var(--danger)' : l.days <= 30 ? 'background:var(--warn)' : 'background:var(--ok)';
      const daysLabel = l.days < 0 ? `${Math.abs(l.days)}d overdue` : l.days === 0 ? 'Today' : `${l.days}d left`;
      const daysColor = l.days < 0 ? 'color:var(--danger)' : l.days <= 7 ? 'color:var(--danger)' : l.days <= 30 ? 'color:var(--warn)' : 'color:var(--ok)';
      return `<div class="upcoming-item">
        <span class="upcoming-dot" style="${dotClass}"></span>
        <div style="flex:1;min-width:0">
          <div class="upcoming-name">${esc(l.name)}</div>
          <div class="upcoming-vault">${esc(l._vaultName)}${l.cost ? ' ¬∑ '+esc(l.cost) : ''}</div>
        </div>
        <div style="text-align:right;flex-shrink:0">
          <div class="upcoming-date">${l.expiry}</div>
          <div class="upcoming-days" style="${daysColor}">${daysLabel}</div>
        </div>
      </div>`;
    }).join('');
  }

  // ‚îÄ‚îÄ Calendar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  _renderCalendar(licenses);
}

window._insightsSetVault = (id) => {
  insightsVaultFilter = id;
  _renderInsights();
};

// ‚îÄ‚îÄ Calendar rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _renderCalendar(licenses) {
  const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  document.getElementById('cal-title').textContent = `${months[calMonth]} ${calYear}`;

  // Build a map of day ‚Üí licenses expiring that day
  const dayMap = {};
  licenses.forEach(l => {
    if (!l.expiry) return;
    const [yr, mo, dy] = l.expiry.split('-').map(Number);
    if (yr === calYear && mo === calMonth + 1) {
      const key = dy;
      if (!dayMap[key]) dayMap[key] = [];
      dayMap[key].push(l);
    }
  });

  const today = new Date();
  const firstDay = new Date(calYear, calMonth, 1).getDay(); // 0=Sun
  const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();

  let html = '';
  // Day name headers
  ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => {
    html += `<div class="cal-day-name">${d}</div>`;
  });

  // Empty cells before first day
  for (let i = 0; i < firstDay; i++) html += '<div class="cal-day empty"></div>';

  // Day cells
  for (let d = 1; d <= daysInMonth; d++) {
    const isToday = today.getFullYear()===calYear && today.getMonth()===calMonth && today.getDate()===d;
    const lics = dayMap[d] || [];
    const dots = lics.slice(0,3).map(l => {
      const days = diff(l.expiry);
      const cls = days < 0 ? 'dot-expired' : days <= 30 ? 'dot-warn' : 'dot-ok';
      return `<div class="cal-dot ${cls}" title="${l.name}">${esc(l.name)}</div>`;
    }).join('');
    const more = lics.length > 3 ? `<div style="font-size:9px;color:var(--faint)">+${lics.length-3} more</div>` : '';
    html += `<div class="cal-day${isToday?' today':''}">
      <div class="cal-day-num">${d}</div>
      ${dots}${more}
    </div>`;
  }

  document.getElementById('cal-grid').innerHTML = html;
}

window._calPrev = () => {
  calMonth--;
  if (calMonth < 0) { calMonth = 11; calYear--; }
  _renderCalendar(_getAllInsightsLicenses());
};
window._calNext = () => {
  calMonth++;
  if (calMonth > 11) { calMonth = 0; calYear++; }
  _renderCalendar(_getAllInsightsLicenses());
};
window._calToday = () => {
  calYear = new Date().getFullYear();
  calMonth = new Date().getMonth();
  _renderCalendar(_getAllInsightsLicenses());
};

// ‚îÄ‚îÄ License Templates (user-defined) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let userTemplates = [];

async function loadUserTemplates() {
  try {
    const snap = await getDocs(collection(db, `users/${currentUser.uid}/templates`));
    userTemplates = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  } catch(e) { userTemplates = []; }
}

function _renderTemplates() {
  const grid = document.getElementById('templates-grid');
  if (!grid) return;
  if (!userTemplates.length) {
    grid.innerHTML = `<div style="font-size:12px;color:var(--faint);font-style:italic;padding:8px 0;">No templates yet. Save a license as a template to reuse it.</div>`;
    return;
  }
  grid.innerHTML = userTemplates.map((t) => `
    <div class="template-card" style="position:relative">
      <div onclick="_applyTemplate('${t.id}')" style="cursor:pointer">
        <div class="template-name">${esc(t.name)}</div>
        <div class="template-vendor">${esc(t.vendor||'')}${t.vendor&&t.category?' ¬∑ ':''}${esc(t.category||'')}</div>
      </div>
      <button onclick="_deleteTemplate('${t.id}')" title="Delete template" style="position:absolute;top:6px;right:6px;width:18px;height:18px;border-radius:3px;border:1px solid var(--border);background:transparent;color:var(--faint);font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;line-height:1;">‚úï</button>
    </div>`).join('');
}

window._applyTemplate = (id) => {
  const t = userTemplates.find(t => t.id === id);
  if (!t) return;
  document.getElementById('f-name').value   = t.name;
  document.getElementById('f-vendor').value = t.vendor || '';
  document.getElementById('f-cost').value   = t.cost || '';
  document.getElementById('f-notes').value  = t.notes || '';
  document.getElementById('f-seats').value  = t.seats || '';
  const catSel = document.getElementById('f-cat');
  [...catSel.options].forEach((o,j) => { if(o.value===t.category) catSel.selectedIndex=j; });
  document.getElementById('f-expiry').focus();
  _checkDuplicate();
};

window._saveAsTemplate = async () => {
  const name = document.getElementById('f-name').value.trim();
  if (!name) { toast('Fill in a license name first.'); return; }
  const seatsVal = document.getElementById('f-seats').value.trim();
  const tmpl = {
    name,
    vendor:   document.getElementById('f-vendor').value.trim(),
    category: document.getElementById('f-cat').value,
    cost:     document.getElementById('f-cost').value.trim(),
    notes:    document.getElementById('f-notes').value.trim(),
    seats:    seatsVal ? parseInt(seatsVal) : null,
    createdAt: new Date().toISOString()
  };
  const id = uid();
  await setDoc(doc(db, `users/${currentUser.uid}/templates/${id}`), tmpl);
  userTemplates.push({ id, ...tmpl });
  _renderTemplates();
  toast(`Template "${name}" saved.`);
};

window._deleteTemplate = async (id) => {
  await deleteDoc(doc(db, `users/${currentUser.uid}/templates/${id}`));
  userTemplates = userTemplates.filter(t => t.id !== id);
  _renderTemplates();
  toast('Template deleted.');
};

// ‚îÄ‚îÄ Duplicate Detection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window._checkDuplicate = () => {
  const name = document.getElementById('f-name').value.trim().toLowerCase();
  const warn = document.getElementById('dup-warning');
  if (!name || name.length < 3) { warn.classList.remove('show'); return; }
  const dup = licenses.find(l => l.name.toLowerCase().includes(name) || name.includes(l.name.toLowerCase()));
  warn.classList.toggle('show', !!dup);
  if (dup) warn.textContent = `‚ö† "${dup.name}" already exists in this vault ‚Äî is this a duplicate?`;
};

// ‚îÄ‚îÄ Dark Mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window._toggleDark = () => {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
  localStorage.setItem('rn-theme', isDark ? 'light' : 'dark');
};

// Apply saved theme on load ‚Äî light is default, dark only if explicitly chosen
(function() {
  const saved = localStorage.getItem('rn-theme');
  if (saved === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
})();

// ‚îÄ‚îÄ CSV Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window._exportCSV = () => {
  const rows = [['Name','Vendor','Category','Expiry','Cost','Seats','Status','Notes']];
  licenses.forEach(l => {
    const d = diff(l.expiry);
    const status = d < 0 ? 'Expired' : d <= 7 ? 'Critical' : d <= 30 ? 'Expiring' : 'Active';
    rows.push([l.name, l.vendor||'', l.category||'', l.expiry, l.cost||'', l.seats||'', status, l.notes||'']);
  });
  const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${currentVault.name.replace(/[^a-z0-9]/gi,'_')}_licenses.csv`;
  a.click(); URL.revokeObjectURL(a.href);
  toast('CSV exported.');
};

// ‚îÄ‚îÄ Bulk Actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window._toggleSelect = (id, checked) => {
  if (checked) selectedIds.add(id); else selectedIds.delete(id);
  _updateBulkBar();
};

window._toggleSelectAll = () => {
  const all = document.getElementById('select-all');
  const sorted = getFiltered();
  if (all.checked) { sorted.forEach(l => selectedIds.add(l.id)); }
  else { sorted.forEach(l => selectedIds.delete(l.id)); }
  _updateBulkBar(); render();
};

function _updateBulkBar() {
  const bar = document.getElementById('bulk-bar');
  const count = document.getElementById('bulk-count');
  bar.classList.toggle('show', selectedIds.size > 0);
  count.textContent = `${selectedIds.size} license${selectedIds.size===1?'':'s'} selected`;
  // sync select-all checkbox
  const all = document.getElementById('select-all');
  const sorted = getFiltered();
  if (all) all.checked = sorted.length > 0 && sorted.every(l => selectedIds.has(l.id));
}

window._clearBulk = () => { selectedIds.clear(); _updateBulkBar(); render(); };

window._bulkDelete = async () => {
  if (!selectedIds.size) return;
  if (!confirm(`Delete ${selectedIds.size} license${selectedIds.size===1?'':'s'}? This cannot be undone.`)) return;
  toast('Deleting‚Ä¶');
  const batch = writeBatch(db);
  selectedIds.forEach(id => batch.delete(doc(db, `vaults/${currentVault.id}/licenses/${id}`)));
  await batch.commit();
  licenses = licenses.filter(l => !selectedIds.has(l.id));
  selectedIds.clear(); _updateBulkBar(); render();
  toast('Deleted.');
};

window._bulkExportCSV = () => {
  const selected = licenses.filter(l => selectedIds.has(l.id));
  const rows = [['Name','Vendor','Category','Expiry','Cost','Seats','Status','Notes']];
  selected.forEach(l => {
    const d = diff(l.expiry);
    const status = d < 0 ? 'Expired' : d <= 7 ? 'Critical' : d <= 30 ? 'Expiring' : 'Active';
    rows.push([l.name, l.vendor||'', l.category||'', l.expiry, l.cost||'', l.seats||'', status, l.notes||'']);
  });
  const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${currentVault.name.replace(/[^a-z0-9]/gi,'_')}_selected.csv`;
  a.click(); URL.revokeObjectURL(a.href);
  toast(`Exported ${selected.length} licenses.`);
};

// ‚îÄ‚îÄ Vault Rename ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window._openRenameVault = (vaultId) => {
  renameVaultTarget = vaultId;
  const vault = myVaults.find(v => v.id === vaultId);
  if (!vault) return;
  document.getElementById('rv-name').value = vault.name;
  document.getElementById('rv-desc').value = vault.desc || '';
  document.getElementById('rename-vault-modal').classList.add('open');
};

window._confirmRenameVault = async () => {
  const name = document.getElementById('rv-name').value.trim();
  if (!name) { toast('Please enter a vault name.'); return; }
  const desc = document.getElementById('rv-desc').value.trim();
  try {
    await setDoc(doc(db, `vaults/${renameVaultTarget}`), { name, desc }, { merge: true });
    await setDoc(doc(db, `users/${currentUser.uid}/vaults/${renameVaultTarget}`), { name }, { merge: true });
    const v = myVaults.find(v => v.id === renameVaultTarget);
    if (v) { v.name = name; v.desc = desc; }
    document.getElementById('rename-vault-modal').classList.remove('open');
    renderDashboard();
    toast('Vault renamed.');
  } catch(e) { toast('Error: ' + e.message); }
};

// ‚îÄ‚îÄ Vault Archive (soft delete) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window._toggleArchiveVault = async (vaultId, archive) => {
  try {
    await setDoc(doc(db, `vaults/${vaultId}`), { archived: archive }, { merge: true });
    const v = myVaults.find(v => v.id === vaultId);
    if (v) v.archived = archive;
    renderDashboard();
    toast(archive ? 'Vault archived.' : 'Vault unarchived.');
  } catch(e) { toast('Error: ' + e.message); }
};

// ‚îÄ‚îÄ Auth enter key ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', e => {
  if (e.key==='Enter' && !document.getElementById('auth-screen').classList.contains('hidden')) window.submitAuth();
});
</script>
</body>
</html>
