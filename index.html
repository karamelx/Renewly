<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Renewly</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:        #f2ece0;
    --surface:   #faf6ef;
    --surface2:  #f5f0e6;
    --border:    #ddd5c4;
    --border2:   #c9bfad;
    --text:      #1e1a14;
    --muted:     #8a7f72;
    --faint:     #b8ad9e;
    --accent:    #6b5335;
    --accent-h:  #5a4429;
    --danger:    #9e3d3a;
    --warn:      #9e6a2a;
    --ok:        #2e6b50;
    --rule:      #d4c9b6;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Outfit', sans-serif;
    font-weight: 400;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 14px;
    line-height: 1.5;
  }

  /* NAV */
  .topnav {
    background: var(--surface);
    border-bottom: 1px solid var(--rule);
    padding: 0 48px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 40;
  }
  .nav-brand { display: flex; align-items: center; gap: 10px; }
  .nav-logo {
    width: 28px; height: 28px;
    background: var(--accent); border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
    color: #faf6ef; font-size: 13px; font-weight: 600; letter-spacing: -0.5px;
  }
  .nav-title { font-weight: 600; font-size: 15px; letter-spacing: 0.2px; }
  .nav-right { display: flex; align-items: center; gap: 8px; }
  .nav-date { font-size: 12px; color: var(--muted); padding-right: 16px; border-right: 1px solid var(--border); margin-right: 4px; }

  /* LAYOUT */
  .page { max-width: 1000px; margin: 0 auto; padding: 40px 48px 80px; }

  /* PAGE HEADER */
  .page-header {
    display: flex; align-items: flex-end; justify-content: space-between;
    margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid var(--rule);
  }
  .page-header h1 {
    font-family: 'Playfair Display', serif; font-weight: 400;
    font-size: 28px; letter-spacing: -0.3px; line-height: 1.2;
  }
  .page-header h1 span { font-style: italic; color: var(--accent); }
  .page-subtitle { font-size: 13px; color: var(--muted); margin-top: 4px; font-weight: 300; }

  /* KPIs */
  .kpi-row {
    display: grid; grid-template-columns: repeat(4, 1fr);
    gap: 1px; background: var(--border);
    border: 1px solid var(--border); border-radius: 8px;
    overflow: hidden; margin-bottom: 36px;
  }
  .kpi { background: var(--surface); padding: 20px 24px; position: relative; }
  .kpi-indicator { position: absolute; top: 0; left: 0; right: 0; height: 3px; }
  .kpi-label { font-size: 11px; font-weight: 500; letter-spacing: 1.8px; text-transform: uppercase; color: var(--faint); margin-bottom: 8px; }
  .kpi-value { font-family: 'Playfair Display', serif; font-size: 32px; font-weight: 400; line-height: 1; color: var(--text); }
  .kpi-sub { font-size: 12px; color: var(--muted); margin-top: 4px; font-weight: 300; }
  .kpi.kpi-danger .kpi-indicator { background: var(--danger); }
  .kpi.kpi-warn   .kpi-indicator { background: var(--warn); }
  .kpi.kpi-ok     .kpi-indicator { background: var(--ok); }
  .kpi.kpi-danger .kpi-value { color: var(--danger); }
  .kpi.kpi-warn   .kpi-value { color: var(--warn); }
  .kpi.kpi-ok     .kpi-value { color: var(--ok); }

  /* TOOLBAR */
  .toolbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .toolbar-left { font-size: 11px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: var(--faint); }

  /* BUTTONS */
  .btn {
    font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 500;
    padding: 9px 20px; border-radius: 5px; border: none; cursor: pointer;
    transition: all 0.15s; letter-spacing: 0.2px; white-space: nowrap;
  }
  .btn-primary { background: var(--accent); color: #faf6ef; }
  .btn-primary:hover { background: var(--accent-h); }
  .btn-ghost { background: transparent; color: var(--muted); border: 1px solid var(--border); }
  .btn-ghost:hover { color: var(--text); border-color: var(--border2); }
  .btn-danger { background: var(--danger); color: #fff; }
  .btn-danger:hover { background: #8a3330; }
  .btn-sm { padding: 7px 14px; font-size: 12px; }
  .btn-icon {
    width: 30px; height: 30px; padding: 0;
    display: flex; align-items: center; justify-content: center;
    background: transparent; border: 1px solid var(--border);
    border-radius: 5px; cursor: pointer; font-size: 13px;
    color: var(--muted); transition: all 0.15s;
  }
  .btn-icon:hover { border-color: var(--border2); background: var(--surface2); color: var(--text); }

  /* TABLE */
  .table-wrap {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; overflow: hidden; margin-bottom: 40px;
  }
  .table-head {
    display: grid; grid-template-columns: 2.2fr 1fr 1.1fr 0.9fr 1.1fr 88px;
    padding: 11px 20px; background: var(--surface2);
    border-bottom: 1px solid var(--border);
    font-size: 11px; font-weight: 600; letter-spacing: 1.6px;
    text-transform: uppercase; color: var(--faint);
  }
  .table-row {
    display: grid; grid-template-columns: 2.2fr 1fr 1.1fr 0.9fr 1.1fr 88px;
    padding: 0 20px; border-bottom: 1px solid var(--border);
    align-items: center; min-height: 60px; transition: background 0.1s;
    animation: rowIn 0.25s ease both; position: relative;
  }
  .table-row:last-child { border-bottom: none; }
  .table-row:hover { background: var(--surface2); }
  .table-row.row-expired  { border-left: 3px solid var(--danger); padding-left: 17px; }
  .table-row.row-critical { border-left: 3px solid var(--danger); padding-left: 17px; }
  .table-row.row-warning  { border-left: 3px solid var(--warn);   padding-left: 17px; }
  @keyframes rowIn { from { opacity:0; transform:translateY(4px); } to { opacity:1; transform:translateY(0); } }

  .row-name { font-weight: 500; font-size: 14px; line-height: 1.3; }
  .row-vendor { font-size: 12px; color: var(--muted); font-weight: 300; margin-top: 2px; }
  .row-cell { font-size: 13px; color: var(--muted); }
  .row-cost { font-size: 13px; color: var(--text); font-weight: 300; }
  .row-actions { display: flex; gap: 4px; justify-content: flex-end; }

  .status-tag {
    display: inline-flex; align-items: center; gap: 5px;
    font-size: 11px; font-weight: 600; letter-spacing: 1px;
    text-transform: uppercase; padding: 4px 10px; border-radius: 3px;
  }
  .tag-expired  { background: rgba(158,61,58,0.1);  color: var(--danger); }
  .tag-critical { background: rgba(158,61,58,0.08); color: var(--danger); }
  .tag-warning  { background: rgba(158,106,42,0.1); color: var(--warn); }
  .tag-ok       { background: rgba(46,107,80,0.08); color: var(--ok); }
  .tag-dot { width: 5px; height: 5px; border-radius: 50%; background: currentColor; }
  .days-count { font-weight: 500; font-size: 11px; margin-top: 3px; }
  .c-danger { color: var(--danger); }
  .c-warn   { color: var(--warn); }
  .c-ok     { color: var(--ok); }

  /* EMPTY */
  .table-empty { padding: 64px 24px; text-align: center; color: var(--muted); }
  .table-empty p { font-size: 14px; margin-top: 8px; font-weight: 300; }

  /* FORM PANEL */
  .form-panel {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; margin-bottom: 36px; overflow: hidden; display: none;
  }
  .form-panel.open { display: block; animation: rowIn 0.2s ease; }
  .form-panel-header {
    padding: 14px 24px; background: var(--surface2);
    border-bottom: 1px solid var(--border);
    font-size: 12px; font-weight: 600; letter-spacing: 1.5px;
    text-transform: uppercase; color: var(--muted);
  }
  .form-body { padding: 24px; }
  .form-grid { display: grid; gap: 18px; margin-bottom: 18px; }
  .fg-3 { grid-template-columns: 1fr 1fr 1fr; }
  .fg-2 { grid-template-columns: 1fr 1fr; }
  .field { display: flex; flex-direction: column; gap: 6px; }
  .field label { font-size: 11px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); }
  .field input, .field select {
    font-family: 'Outfit', sans-serif; font-size: 13px; font-weight: 400;
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 5px; padding: 10px 14px; color: var(--text);
    outline: none; transition: border-color 0.15s; -webkit-appearance: none;
  }
  .field input:focus, .field select:focus { border-color: var(--accent); }
  .field input::placeholder { color: var(--faint); }

  .chips-group { margin-bottom: 20px; }
  .chips-group label { display: block; font-size: 11px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); margin-bottom: 10px; }
  .chips { display: flex; gap: 6px; flex-wrap: wrap; }
  .chip {
    padding: 5px 14px; border-radius: 3px; border: 1px solid var(--border);
    background: var(--bg); font-family: 'Outfit', sans-serif; font-size: 12px;
    cursor: pointer; transition: all 0.12s; color: var(--muted); user-select: none;
  }
  .chip.on { border-color: var(--accent); background: rgba(107,83,53,0.09); color: var(--accent); font-weight: 500; }
  .chip:hover:not(.on) { border-color: var(--border2); color: var(--text); }
  .form-actions { display: flex; gap: 10px; padding-top: 4px; }

  /* SETTINGS */
  .settings-panel {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; overflow: hidden; margin-bottom: 40px;
  }
  .settings-panel-header {
    padding: 14px 24px; background: var(--surface2); border-bottom: 1px solid var(--border);
    font-size: 12px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted);
  }
  .settings-body { padding: 24px; }
  .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 32px; }
  .settings-block { display: flex; flex-direction: column; gap: 14px; }
  .settings-block h4 { font-size: 13px; font-weight: 600; color: var(--text); }
  .settings-block p { font-size: 12px; color: var(--muted); font-weight: 300; margin-top: -6px; }
  .action-row {
    display: flex; align-items: center; gap: 10px;
    padding: 16px 24px; border-top: 1px solid var(--border);
    background: var(--surface2); flex-wrap: wrap;
  }
  .action-row-note { font-size: 12px; color: var(--faint); font-weight: 300; margin-left: 4px; }
  .divider { width: 1px; height: 16px; background: var(--border); margin: 0 4px; }
  .text-link {
    background: none; border: none; font-family: 'Outfit', sans-serif;
    font-size: 12px; color: var(--muted); cursor: pointer;
    text-decoration: underline; text-underline-offset: 3px;
    transition: color 0.15s; padding: 0;
  }
  .text-link:hover { color: var(--accent); }

  /* MODAL */
  .overlay { position: fixed; inset: 0; background: rgba(30,26,20,0.4); z-index: 50; display: none; align-items: center; justify-content: center; }
  .overlay.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; width: 420px; max-width: 92vw; overflow: hidden; animation: rowIn 0.18s ease; }
  .modal-header { padding: 20px 24px 12px; }
  .modal h3 { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 400; }
  .modal-body { padding: 0 24px 4px; font-size: 13px; color: var(--muted); font-weight: 300; }
  .modal-footer { display: flex; gap: 8px; padding: 16px 24px; border-top: 1px solid var(--border); margin-top: 16px; background: var(--surface2); }

  /* TOAST */
  .toast { position: fixed; bottom: 24px; right: 24px; background: var(--text); color: var(--surface); padding: 10px 18px; border-radius: 5px; font-size: 12px; font-weight: 500; z-index: 100; opacity: 0; transform: translateY(10px); transition: all 0.18s; pointer-events: none; }
  .toast.show { opacity: 1; transform: translateY(0); }

  @media (max-width: 720px) {
    .topnav { padding: 0 20px; }
    .page { padding: 24px 20px 60px; }
    .kpi-row { grid-template-columns: 1fr 1fr; }
    .table-head > *:nth-child(2), .table-head > *:nth-child(3), .table-head > *:nth-child(4),
    .table-row  > *:nth-child(2), .table-row  > *:nth-child(3), .table-row  > *:nth-child(4) { display: none; }
    .table-head, .table-row { grid-template-columns: 1fr auto auto; }
    .fg-3, .fg-2 { grid-template-columns: 1fr; }
    .settings-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<nav class="topnav">
  <div class="nav-brand">
    <div class="nav-logo">R</div>
    <span class="nav-title">Renewly</span>
  </div>
  <div class="nav-right">
    <span class="nav-date" id="nav-date"></span>
    <button class="btn btn-primary btn-sm" onclick="_toggleForm()">+ Add License</button>
  </div>
</nav>

<div class="page">

  <div class="page-header">
    <div>
      <h1>Your <span>Renewly</span></h1>
      <p class="page-subtitle">Track, manage, and get reminded before licenses expire.</p>
    </div>
  </div>

  <div class="kpi-row">
    <div class="kpi">
      <div class="kpi-indicator"></div>
      <div class="kpi-label">Total</div>
      <div class="kpi-value" id="k-total">0</div>
      <div class="kpi-sub">licenses tracked</div>
    </div>
    <div class="kpi kpi-danger">
      <div class="kpi-indicator"></div>
      <div class="kpi-label">Expired</div>
      <div class="kpi-value" id="k-expired">0</div>
      <div class="kpi-sub">action required</div>
    </div>
    <div class="kpi kpi-warn">
      <div class="kpi-indicator"></div>
      <div class="kpi-label">Expiring Soon</div>
      <div class="kpi-value" id="k-warn">0</div>
      <div class="kpi-sub">within 30 days</div>
    </div>
    <div class="kpi kpi-ok">
      <div class="kpi-indicator"></div>
      <div class="kpi-label">Active</div>
      <div class="kpi-value" id="k-ok">0</div>
      <div class="kpi-sub">in good standing</div>
    </div>
  </div>

  <!-- FORM -->
  <div class="form-panel" id="add-form">
    <div class="form-panel-header">New License Entry</div>
    <div class="form-body">
      <div class="form-grid fg-3">
        <div class="field"><label>License Name *</label><input id="f-name" placeholder="e.g. Adobe Creative Cloud"></div>
        <div class="field"><label>Vendor</label><input id="f-vendor" placeholder="e.g. Adobe Inc."></div>
        <div class="field"><label>Category</label>
          <select id="f-cat">
            <option>Software</option><option>SaaS</option><option>Domain</option>
            <option>SSL / Security</option><option>Hardware</option><option>Other</option>
          </select>
        </div>
      </div>
      <div class="form-grid fg-2">
        <div class="field"><label>Expiration Date *</label><input type="date" id="f-expiry"></div>
        <div class="field"><label>Annual Cost</label><input id="f-cost" placeholder="e.g. $299 / year"></div>
      </div>
      <div class="chips-group">
        <label>Reminder Intervals (days before expiry)</label>
        <div class="chips" id="form-chips">
          <div class="chip" data-d="90">90 days</div>
          <div class="chip on" data-d="60">60 days</div>
          <div class="chip on" data-d="30">30 days</div>
          <div class="chip" data-d="14">14 days</div>
          <div class="chip on" data-d="7">7 days</div>
          <div class="chip" data-d="3">3 days</div>
          <div class="chip" data-d="1">1 day</div>
        </div>
      </div>
      <div class="field" style="margin-bottom:22px;"><label>Internal Notes</label><input id="f-notes" placeholder="Seat count, account owner, renewal contactâ€¦"></div>
      <div class="form-actions">
        <button class="btn btn-primary" onclick="_addLicense()">Save Entry</button>
        <button class="btn btn-ghost" onclick="_toggleForm()">Discard</button>
      </div>
    </div>
  </div>

  <div class="toolbar">
    <span class="toolbar-left">All Licenses</span>
    <span style="font-size:12px;color:var(--faint)" id="row-count"></span>
  </div>

  <div class="table-wrap">
    <div class="table-head">
      <div>License</div><div>Category</div><div>Expires</div>
      <div>Cost</div><div>Status</div><div style="text-align:right">Actions</div>
    </div>
    <div id="license-list"></div>
  </div>

  <div class="settings-panel">
    <div class="settings-panel-header">Notification Settings</div>
    <div class="settings-body">
      <div class="settings-grid">
        <div class="settings-block">
          <div>
            <h4>Recipient Email</h4>
            <p>Reminders will be sent to this address via your default email client.</p>
          </div>
          <div class="field"><input type="email" id="s-email" placeholder="you@company.com" oninput="_saveSettings()"></div>
        </div>
        <div class="settings-block">
          <div>
            <h4>Default Reminder Schedule</h4>
            <p>Applied to all licenses unless overridden per entry.</p>
          </div>
          <div class="chips" id="global-chips">
            <div class="chip" data-d="90">90d</div>
            <div class="chip on" data-d="60">60d</div>
            <div class="chip on" data-d="30">30d</div>
            <div class="chip" data-d="14">14d</div>
            <div class="chip on" data-d="7">7d</div>
            <div class="chip" data-d="3">3d</div>
            <div class="chip" data-d="1">1d</div>
          </div>
        </div>
      </div>
    </div>
    <div class="action-row">
      <button class="btn btn-primary" onclick="_sendAll()">Send Reminders</button>
      <div class="divider"></div>
      <button class="text-link" onclick="_exportData()">Export JSON</button>
      <button class="text-link" onclick="document.getElementById('imp').click()">Import JSON</button>
      <input type="file" id="imp" style="display:none" accept=".json" onchange="_importData(event)">
      <span class="action-row-note">Opens your email client with all due licenses pre-filled</span>
    </div>
  </div>

</div>

<!-- MODAL -->
<div class="overlay" id="del-modal">
  <div class="modal">
    <div class="modal-header"><h3>Remove License?</h3></div>
    <div class="modal-body">This entry will be permanently deleted. This action cannot be undone.</div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="_confirmDelete()">Remove Entry</button>
      <button class="btn btn-ghost" onclick="_closeModal()">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, doc, getDocs, setDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBxSpcb3DMtv7UWStqrxA9xULASE7eE_kI",
    authDomain: "renewly-af1de.firebaseapp.com",
    projectId: "renewly-af1de",
    storageBucket: "renewly-af1de.firebasestorage.app",
    messagingSenderId: "730729566841",
    appId: "1:730729566841:web:7d45d0a548e4800b14faa8",
    measurementId: "G-0TCBK03B6T"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let licenses = [];
  let settings = {email:'', intervals:[60,30,7]};
  let delTarget = null;

  function uid()     { return Date.now().toString(36)+Math.random().toString(36).slice(2); }
  function offset(d) { const dt=new Date(); dt.setDate(dt.getDate()+d); return dt.toISOString().split('T')[0]; }
  function diff(exp) { const n=new Date(); n.setHours(0,0,0,0); return Math.round((new Date(exp+'T00:00:00')-n)/86400000); }
  function esc(s)    { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2800); }

  async function loadData() {
    toast('Loadingâ€¦');
    // Load licenses
    const snap = await getDocs(collection(db, 'licenses'));
    licenses = snap.docs.map(d => ({id: d.id, ...d.data()}));

    // Load settings
    const sSnap = await getDoc(doc(db, 'settings', 'global'));
    if (sSnap.exists()) {
      settings = sSnap.data();
      document.getElementById('s-email').value = settings.email || '';
      document.querySelectorAll('#global-chips .chip').forEach(c => {
        c.classList.toggle('on', (settings.intervals||[]).includes(+c.dataset.d));
      });
    }

    if (!licenses.length) {
      // Seed with demo data on first load
      const demos = [
        {id:uid(),name:'Adobe Creative Cloud',vendor:'Adobe Inc.',category:'SaaS',expiry:offset(5),cost:'$599 / yr',notes:'5 seats â€” design team',reminders:[60,30,7]},
        {id:uid(),name:'company.com',vendor:'GoDaddy',category:'Domain',expiry:offset(-3),cost:'$15 / yr',notes:'Auto-renew is OFF',reminders:[30,7,1]},
        {id:uid(),name:'GitHub Enterprise',vendor:'GitHub',category:'SaaS',expiry:offset(45),cost:'$21 / user / mo',notes:'20 seats',reminders:[60,30,7]},
        {id:uid(),name:'SSL Wildcard Certificate',vendor:'DigiCert',category:'SSL / Security',expiry:offset(120),cost:'$299 / yr',notes:'Covers *.company.com',reminders:[60,30,7]},
      ];
      for (const lic of demos) {
        await setDoc(doc(db, 'licenses', lic.id), lic);
      }
      licenses = demos;
    }
    render();
  }

  async function saveLicense(lic) {
    await setDoc(doc(db, 'licenses', lic.id), lic);
  }

  async function deleteLicense(id) {
    await deleteDoc(doc(db, 'licenses', id));
  }

  async function saveSettings() {
    settings.email = document.getElementById('s-email').value;
    await setDoc(doc(db, 'settings', 'global'), settings);
  }

  async function saveGlobalIntervals() {
    settings.intervals = [...document.querySelectorAll('#global-chips .chip.on')].map(c=>+c.dataset.d);
    await setDoc(doc(db, 'settings', 'global'), settings);
  }

  function statusOf(days) {
    if (days < 0)   return {row:'row-expired',  tag:'tag-expired',  label:'Expired',  dc:'c-danger', dtext:`${Math.abs(days)}d overdue`};
    if (days <= 7)  return {row:'row-critical', tag:'tag-critical', label:'Critical', dc:'c-danger', dtext:`${days}d left`};
    if (days <= 30) return {row:'row-warning',  tag:'tag-warning',  label:'Expiring', dc:'c-warn',   dtext:`${days}d left`};
    return              {row:'',             tag:'tag-ok',       label:'Active',   dc:'c-ok',     dtext:`${days}d left`};
  }

  function render() {
    const sorted = [...licenses].sort((a,b)=>diff(a.expiry)-diff(b.expiry));
    const list   = document.getElementById('license-list');
    if (!sorted.length) {
      list.innerHTML = `<div class="table-empty"><div style="font-size:28px;opacity:.2;margin-bottom:8px">ðŸ“‹</div><p>No licenses tracked. Add your first entry above.</p></div>`;
    } else {
      list.innerHTML = sorted.map((lic,i) => {
        const days=diff(lic.expiry), s=statusOf(days);
        return `
          <div class="table-row ${s.row}" style="animation-delay:${i*35}ms">
            <div>
              <div class="row-name">${esc(lic.name)}</div>
              <div class="row-vendor">${esc(lic.vendor||'â€”')}${lic.notes?` Â· <span style="color:var(--faint)">${esc(lic.notes)}</span>`:''}</div>
            </div>
            <div class="row-cell">${esc(lic.category)}</div>
            <div class="row-cell">${lic.expiry}</div>
            <div class="row-cost">${esc(lic.cost||'â€”')}</div>
            <div>
              <span class="status-tag ${s.tag}"><span class="tag-dot"></span>${s.label}</span>
              <div class="days-count ${s.dc}">${s.dtext}</div>
            </div>
            <div class="row-actions">
              <button class="btn-icon" title="Send reminder" onclick="window._emailOne('${lic.id}')">âœ‰</button>
              <button class="btn-icon" title="Delete" onclick="window._promptDelete('${lic.id}')">âœ•</button>
            </div>
          </div>`;
      }).join('');
    }
    document.getElementById('row-count').textContent = licenses.length ? `${licenses.length} entr${licenses.length===1?'y':'ies'}` : '';
    document.getElementById('k-total').textContent   = licenses.length;
    document.getElementById('k-expired').textContent = licenses.filter(l=>diff(l.expiry)<0).length;
    document.getElementById('k-warn').textContent    = licenses.filter(l=>{const d=diff(l.expiry);return d>=0&&d<=30;}).length;
    document.getElementById('k-ok').textContent      = licenses.filter(l=>diff(l.expiry)>30).length;
  }

  // Expose functions to global scope for inline onclick handlers
  window._toggleForm = () => document.getElementById('add-form').classList.toggle('open');

  window._addLicense = async () => {
    const name=document.getElementById('f-name').value.trim();
    const expiry=document.getElementById('f-expiry').value;
    if (!name||!expiry) { toast('License name and expiry date are required.'); return; }
    const lic = {
      id:uid(), name,
      vendor:   document.getElementById('f-vendor').value.trim(),
      category: document.getElementById('f-cat').value,
      expiry,
      cost:     document.getElementById('f-cost').value.trim(),
      notes:    document.getElementById('f-notes').value.trim(),
      reminders:[...document.querySelectorAll('#form-chips .chip.on')].map(c=>+c.dataset.d)
    };
    toast('Savingâ€¦');
    await saveLicense(lic);
    licenses.push(lic);
    render();
    ['f-name','f-vendor','f-expiry','f-cost','f-notes'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('add-form').classList.remove('open');
    toast('License entry saved.');
  };

  window._promptDelete = (id) => { delTarget=id; document.getElementById('del-modal').classList.add('open'); };
  window._closeModal   = ()   => { document.getElementById('del-modal').classList.remove('open'); delTarget=null; };

  window._confirmDelete = async () => {
    await deleteLicense(delTarget);
    licenses = licenses.filter(l=>l.id!==delTarget);
    render(); window._closeModal(); toast('Entry removed.');
  };

  window._saveSettings = saveSettings;
  window._saveGlobalIntervals = saveGlobalIntervals;

  function dueLicenses() {
    return licenses.map(l=>({l,days:diff(l.expiry)}))
      .filter(({l,days})=>days<0||(l.reminders||settings.intervals).some(r=>days<=r))
      .sort((a,b)=>a.days-b.days);
  }
  function buildBody(items) {
    let b=`LICENSE RENEWAL REMINDERS\n${new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}\n${'â”€'.repeat(40)}\n\n`;
    items.forEach(({l,days})=>{
      b+=`${l.name.toUpperCase()}${l.vendor?' â€” '+l.vendor:''}\n`;
      b+=days<0?`  EXPIRED â€” ${Math.abs(days)} day(s) ago\n`:`  Expires in ${days} day(s) (${l.expiry})\n`;
      if(l.cost)  b+=`  Cost: ${l.cost}\n`;
      if(l.notes) b+=`  Notes: ${l.notes}\n`;
      b+='\n';
    });
    b+='â”€'.repeat(40)+'\nGenerated by Renewly';
    return b;
  }

  window._sendAll = () => {
    const email=settings.email;
    if (!email) { toast('Please enter your email address in Notification Settings.'); document.getElementById('s-email').focus(); return; }
    const due=dueLicenses();
    if (!due.length) { toast('No reminders are due at this time.'); return; }
    window.open(`mailto:${email}?subject=${encodeURIComponent('License Reminders â€” '+due.length+' require attention')}&body=${encodeURIComponent(buildBody(due))}`);
  };

  window._emailOne = (id) => {
    const lic=licenses.find(l=>l.id===id); if(!lic) return;
    if (!settings.email) { toast('Please enter your email address in Notification Settings.'); return; }
    const days=diff(lic.expiry);
    window.open(`mailto:${settings.email}?subject=${encodeURIComponent('License Reminder: '+lic.name)}&body=${encodeURIComponent(buildBody([{l:lic,days}]))}`);
  };

  window._exportData = () => {
    const a=document.createElement('a');
    a.href=URL.createObjectURL(new Blob([JSON.stringify({licenses,settings},null,2)],{type:'application/json'}));
    a.download=`renewly-${new Date().toISOString().split('T')[0]}.json`;
    a.click(); toast('Data exported.');
  };

  window._importData = async (e) => {
    const file=e.target.files[0]; if(!file) return;
    const r=new FileReader();
    r.onload=async ev=>{
      try {
        const d=JSON.parse(ev.target.result);
        if(d.licenses) {
          for (const lic of d.licenses) await saveLicense(lic);
          licenses = d.licenses;
        }
        if(d.settings) {
          settings=d.settings;
          document.getElementById('s-email').value=settings.email||'';
          await saveSettings();
        }
        render(); toast('Data imported successfully.');
      } catch { toast('Unable to parse the selected file.'); }
    };
    r.readAsText(file); e.target.value='';
  };

  // Init
  window.addEventListener('DOMContentLoaded', () => {
    const d = new Date();
    document.getElementById('nav-date').textContent =
      d.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});

    document.querySelectorAll('#global-chips .chip').forEach(c => {
      c.classList.toggle('on', settings.intervals.includes(+c.dataset.d));
      c.onclick = () => { c.classList.toggle('on'); window._saveGlobalIntervals(); };
    });
    document.querySelectorAll('#form-chips .chip').forEach(c => { c.onclick = () => c.classList.toggle('on'); });

    loadData();
  });
</script>
</body>
</html>
